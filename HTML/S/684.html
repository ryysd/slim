<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'>
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
<title>third_party/google-perftools-1.8.3/src/windows/patch_functions.cc</title>
<meta name='robots' content='noindex,nofollow' />
<meta name='generator' content='GLOBAL-6.1' />
<meta http-equiv='Content-Style-Type' content='text/css' />
<link rel='stylesheet' type='text/css' href='../style.css' />
</head>
<body>
<a id='TOP' name='TOP' /><h2 class='header'><a href='../mains.html'>root</a>/<a href='../files/738.html'>third_party</a>/<a href='../files/739.html'>google-perftools-1.8.3</a>/<a href='../files/740.html'>src</a>/<a href='../files/745.html'>windows</a>/patch_functions.cc</h2>
<em class='comment'>/* [&lt;][&gt;]<a href='#L123'>[^]</a><a href='#L1057'>[v]</a>[top]<a href='#BOTTOM'>[bottom]</a><a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</em>
<hr />
<h2 class='header'>DEFINITIONS</h2>
This source file includes following definitions.
<ol>
<li><a href='#L123' title='Defined at 123.'>_tcmalloc</a></li>
<li><a href='#L128' title='Defined at 128.'>__tcmalloc</a></li>
<li><a href='#L153' title='Defined at 153.'>patched</a></li>
<li><a href='#L154' title='Defined at 154.'>set_is_valid</a></li>
<li><a href='#L158' title='Defined at 158.'>hmodule</a></li>
<li><a href='#L169' title='Defined at 169.'>CopyFrom</a></li>
<li><a href='#L221' title='Defined at 221.'>is_valid</a></li>
<li><a href='#L222' title='Defined at 222.'>windows_fn</a></li>
<li><a href='#L227' title='Defined at 227.'>static_fn</a></li>
<li><a href='#L230' title='Defined at 230.'>function_name</a></li>
<li><a href='#L792' title='Defined at 792.'>Perftools_malloc</a></li>
<li><a href='#L799' title='Defined at 799.'>Perftools_free</a></li>
<li><a href='#L809' title='Defined at 809.'>Perftools_realloc</a></li>
<li><a href='#L829' title='Defined at 829.'>Perftools_calloc</a></li>
<li><a href='#L837' title='Defined at 837.'>Perftools_new</a></li>
<li><a href='#L844' title='Defined at 844.'>Perftools_newarray</a></li>
<li><a href='#L851' title='Defined at 851.'>Perftools_delete</a></li>
<li><a href='#L857' title='Defined at 857.'>Perftools_deletearray</a></li>
<li><a href='#L863' title='Defined at 863.'>Perftools_new_nothrow</a></li>
<li><a href='#L871' title='Defined at 871.'>Perftools_newarray_nothrow</a></li>
<li><a href='#L879' title='Defined at 879.'>Perftools_delete_nothrow</a></li>
<li><a href='#L886' title='Defined at 886.'>Perftools_deletearray_nothrow</a></li>
<li><a href='#L902' title='Defined at 902.'>Perftools__msize</a></li>
<li><a href='#L910' title='Defined at 910.'>Perftools__expand</a></li>
<li><a href='#L915' title='Defined at 915.'>Perftools_HeapAlloc</a></li>
<li><a href='#L924' title='Defined at 924.'>Perftools_HeapFree</a></li>
<li><a href='#L932' title='Defined at 932.'>Perftools_VirtualAllocEx</a></li>
<li><a href='#L944' title='Defined at 944.'>Perftools_VirtualFreeEx</a></li>
<li><a href='#L952' title='Defined at 952.'>Perftools_MapViewOfFileEx</a></li>
<li><a href='#L966' title='Defined at 966.'>Perftools_UnmapViewOfFile</a></li>
<li><a href='#L983' title='Defined at 983.'>Perftools_LoadLibraryExW</a></li>
<li><a href='#L1006' title='Defined at 1006.'>Perftools_FreeLibrary</a></li>
<li><a href='#L1035' title='Defined at 1035.'>PatchWindowsFunctions</a></li>
<li><a href='#L1057' title='Defined at 1057.'>UnpatchWindowsFunctions</a></li>
</ol>
<hr />
<pre>
<a id='L1' name='L1' /><em class='comment'>// Copyright (c) 2007, Google Inc.</em>
<a id='L2' name='L2' /><em class='comment'>// All rights reserved.</em>
<a id='L3' name='L3' /><em class='comment'>// </em>
<a id='L4' name='L4' /><em class='comment'>// Redistribution and use in source and binary forms, with or without</em>
<a id='L5' name='L5' /><em class='comment'>// modification, are permitted provided that the following conditions are</em>
<a id='L6' name='L6' /><em class='comment'>// met:</em>
<a id='L7' name='L7' /><em class='comment'>// </em>
<a id='L8' name='L8' /><em class='comment'>//     * Redistributions of source code must retain the above copyright</em>
<a id='L9' name='L9' /><em class='comment'>// notice, this list of conditions and the following disclaimer.</em>
<a id='L10' name='L10' /><em class='comment'>//     * Redistributions in binary form must reproduce the above</em>
<a id='L11' name='L11' /><em class='comment'>// copyright notice, this list of conditions and the following disclaimer</em>
<a id='L12' name='L12' /><em class='comment'>// in the documentation and/or other materials provided with the</em>
<a id='L13' name='L13' /><em class='comment'>// distribution.</em>
<a id='L14' name='L14' /><em class='comment'>//     * Neither the name of Google Inc. nor the names of its</em>
<a id='L15' name='L15' /><em class='comment'>// contributors may be used to endorse or promote products derived from</em>
<a id='L16' name='L16' /><em class='comment'>// this software without specific prior written permission.</em>
<a id='L17' name='L17' /><em class='comment'>// </em>
<a id='L18' name='L18' /><em class='comment'>// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</em>
<a id='L19' name='L19' /><em class='comment'>// "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</em>
<a id='L20' name='L20' /><em class='comment'>// LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</em>
<a id='L21' name='L21' /><em class='comment'>// A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</em>
<a id='L22' name='L22' /><em class='comment'>// OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</em>
<a id='L23' name='L23' /><em class='comment'>// SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</em>
<a id='L24' name='L24' /><em class='comment'>// LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</em>
<a id='L25' name='L25' /><em class='comment'>// DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</em>
<a id='L26' name='L26' /><em class='comment'>// THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</em>
<a id='L27' name='L27' /><em class='comment'>// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</em>
<a id='L28' name='L28' /><em class='comment'>// OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</em>
<a id='L29' name='L29' /><em class='comment'>//</em>
<a id='L30' name='L30' /><em class='comment'>// ---</em>
<a id='L31' name='L31' /><em class='comment'>// Author: Craig Silverstein</em>
<a id='L32' name='L32' /><em class='comment'>//</em>
<a id='L33' name='L33' /><em class='comment'>// The main purpose of this file is to patch the libc allocation</em>
<a id='L34' name='L34' /><em class='comment'>// routines (malloc and friends, but also _msize and other</em>
<a id='L35' name='L35' /><em class='comment'>// windows-specific libc-style routines).  However, we also patch</em>
<a id='L36' name='L36' /><em class='comment'>// windows routines to do accounting.  We do better at the former than</em>
<a id='L37' name='L37' /><em class='comment'>// the latter.  Here are some comments from Paul Pluzhnikov about what</em>
<a id='L38' name='L38' /><em class='comment'>// it might take to do a really good job patching windows routines to</em>
<a id='L39' name='L39' /><em class='comment'>// keep track of memory usage:</em>
<a id='L40' name='L40' /><em class='comment'>//</em>
<a id='L41' name='L41' /><em class='comment'>// "You should intercept at least the following:</em>
<a id='L42' name='L42' /><em class='comment'>//     HeapCreate HeapDestroy HeapAlloc HeapReAlloc HeapFree</em>
<a id='L43' name='L43' /><em class='comment'>//     RtlCreateHeap RtlDestroyHeap RtlAllocateHeap RtlFreeHeap</em>
<a id='L44' name='L44' /><em class='comment'>//     malloc calloc realloc free</em>
<a id='L45' name='L45' /><em class='comment'>//     malloc_dbg calloc_dbg realloc_dbg free_dbg</em>
<a id='L46' name='L46' /><em class='comment'>// Some of these call the other ones (but not always), sometimes</em>
<a id='L47' name='L47' /><em class='comment'>// recursively (i.e. HeapCreate may call HeapAlloc on a different</em>
<a id='L48' name='L48' /><em class='comment'>// heap, IIRC)."</em>
<a id='L49' name='L49' /><em class='comment'>//</em>
<a id='L50' name='L50' /><em class='comment'>// Since Paul didn't mention VirtualAllocEx, he may not have even been</em>
<a id='L51' name='L51' /><em class='comment'>// considering all the mmap-like functions that windows has (or he may</em>
<a id='L52' name='L52' /><em class='comment'>// just be ignoring it because he's seen we already patch it).  Of the</em>
<a id='L53' name='L53' /><em class='comment'>// above, we do not patch the *_dbg functions, and of the windows</em>
<a id='L54' name='L54' /><em class='comment'>// functions, we only patch HeapAlloc and HeapFree.</em>
<a id='L55' name='L55' /><em class='comment'>//</em>
<a id='L56' name='L56' /><em class='comment'>// The *_dbg functions come into play with /MDd, /MTd, and /MLd,</em>
<a id='L57' name='L57' /><em class='comment'>// probably.  It may be ok to just turn off tcmalloc in those cases --</em>
<a id='L58' name='L58' /><em class='comment'>// if the user wants the windows debug malloc, they probably don't</em>
<a id='L59' name='L59' /><em class='comment'>// want tcmalloc!  We should also test with all of /MD, /MT, and /ML,</em>
<a id='L60' name='L60' /><em class='comment'>// which we're not currently doing.</em>
<a id='L61' name='L61' />
<a id='L62' name='L62' /><em class='comment'>// TODO(csilvers): try to do better here?  Paul does conclude:</em>
<a id='L63' name='L63' /><em class='comment'>//                 "Keeping track of all of this was a nightmare."</em>
<a id='L64' name='L64' />
<a id='L65' name='L65' /><em class='sharp'>#ifndef</em> <a href='../Y/997.html' title='Multiple used in 42 places.'>_WIN32</a>
<a id='L66' name='L66' /><em class='sharp'># error</em> You should only be including windows/patch_functions.cc in a windows environment!
<a id='L67' name='L67' /><em class='sharp'>#endif</em>
<a id='L68' name='L68' />
<a id='L69' name='L69' /><em class='sharp'>#include</em> &lt;<a href='../I/6.html'>config.h</a>&gt;
<a id='L70' name='L70' />
<a id='L71' name='L71' /><em class='sharp'>#ifdef</em> <a href='../S/672.html#L20' title='Defined at 20 in third_party/google-perftools-1.8.3/src/windows/config.h.'>WIN32_OVERRIDE_ALLOCATORS</a>
<a id='L72' name='L72' /><em class='sharp'>#error</em> This file is intended <strong class='reserved'>for</strong> patching allocators - use override_functions.cc instead.
<a id='L73' name='L73' /><em class='sharp'>#endif</em>
<a id='L74' name='L74' />
<a id='L75' name='L75' /><em class='comment'>// We use psapi.  Non-MSVC systems will have to link this in themselves.</em>
<a id='L76' name='L76' /><em class='sharp'>#ifdef</em> <a href='../Y/982.html' title='Multiple used in 81 places.'>_MSC_VER</a>
<a id='L77' name='L77' /><em class='sharp'>#pragma</em> comment(lib, "Psapi.lib")
<a id='L78' name='L78' /><em class='sharp'>#endif</em>
<a id='L79' name='L79' />
<a id='L80' name='L80' /><em class='comment'>// Make sure we always use the 'old' names of the psapi functions.</em>
<a id='L81' name='L81' /><em class='sharp'>#ifndef</em> <a href='../S/684.html#L82' title='Defined at 82 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>PSAPI_VERSION</a>
<a id='L82' name='L82' /><em class='sharp'>#define</em> <a href='../S/684.html#L81' title='Refered from 81 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>PSAPI_VERSION</a> 1
<a id='L83' name='L83' /><em class='sharp'>#endif</em>
<a id='L84' name='L84' />
<a id='L85' name='L85' /><em class='sharp'>#include</em> &lt;windows.h&gt;
<a id='L86' name='L86' /><em class='sharp'>#include</em> &lt;stdio.h&gt;
<a id='L87' name='L87' /><em class='sharp'>#include</em> &lt;malloc.h&gt;       <em class='comment'>// for _msize and _expand</em>
<a id='L88' name='L88' /><em class='sharp'>#include</em> &lt;Psapi.h&gt;        <em class='comment'>// for EnumProcessModules, GetModuleInformation, etc.</em>
<a id='L89' name='L89' /><em class='sharp'>#include</em> &lt;set&gt;
<a id='L90' name='L90' /><em class='sharp'>#include</em> &lt;map&gt;
<a id='L91' name='L91' /><em class='sharp'>#include</em> &lt;vector&gt;
<a id='L92' name='L92' /><em class='sharp'>#include</em> &lt;<a href='529.html'>base/logging.h</a>&gt;
<a id='L93' name='L93' /><em class='sharp'>#include</em> "<a href='534.html'>base/spinlock.h</a>"
<a id='L94' name='L94' /><em class='sharp'>#include</em> "<a href='561.html'>google/malloc_hook.h</a>"
<a id='L95' name='L95' /><em class='sharp'>#include</em> "<a href='581.html'>malloc_hook-inl.h</a>"
<a id='L96' name='L96' /><em class='sharp'>#include</em> "<a href='688.html'>preamble_patcher.h</a>"
<a id='L97' name='L97' />
<a id='L98' name='L98' /><em class='comment'>// The maximum number of modules we allow to be in one executable</em>
<a id='L99' name='L99' /><strong class='reserved'>const</strong> <strong class='reserved'>int</strong> <a href='../Y/3058.html' title='Multiple used in 4 places.'>kMaxModules</a> = 8182;
<a id='L100' name='L100' />
<a id='L101' name='L101' /><em class='comment'>// These are hard-coded, unfortunately. :-( They are also probably</em>
<a id='L102' name='L102' /><em class='comment'>// compiler specific.  See get_mangled_names.cc, in this directory,</em>
<a id='L103' name='L103' /><em class='comment'>// for instructions on how to update these names for your compiler.</em>
<a id='L104' name='L104' /><strong class='reserved'>const</strong> <strong class='reserved'>char</strong> <a href='../Y/3046.html' title='Multiple used in 2 places.'>kMangledNew</a>[] = "??2@YAPAXI@Z";
<a id='L105' name='L105' /><strong class='reserved'>const</strong> <strong class='reserved'>char</strong> <a href='../Y/3047.html' title='Multiple used in 2 places.'>kMangledNewArray</a>[] = "??_U@YAPAXI@Z";
<a id='L106' name='L106' /><strong class='reserved'>const</strong> <strong class='reserved'>char</strong> <a href='../Y/3042.html' title='Multiple used in 2 places.'>kMangledDelete</a>[] = "??3@YAXPAX@Z";
<a id='L107' name='L107' /><strong class='reserved'>const</strong> <strong class='reserved'>char</strong> <a href='../Y/3043.html' title='Multiple used in 2 places.'>kMangledDeleteArray</a>[] = "??_V@YAXPAX@Z";
<a id='L108' name='L108' /><strong class='reserved'>const</strong> <strong class='reserved'>char</strong> kMangledNewNothrow[] = "??2@YAPAXIABUnothrow_t@std@@@Z";
<a id='L109' name='L109' /><strong class='reserved'>const</strong> <strong class='reserved'>char</strong> kMangledNewArrayNothrow[] = "??_U@YAPAXIABUnothrow_t@std@@@Z";
<a id='L110' name='L110' /><strong class='reserved'>const</strong> <strong class='reserved'>char</strong> kMangledDeleteNothrow[] = "??3@YAXPAXABUnothrow_t@std@@@Z";
<a id='L111' name='L111' /><strong class='reserved'>const</strong> <strong class='reserved'>char</strong> kMangledDeleteArrayNothrow[] = "??_V@YAXPAXABUnothrow_t@std@@@Z";
<a id='L112' name='L112' />
<a id='L113' name='L113' /><em class='comment'>// This is an unused but exported symbol that we can use to tell the</em>
<a id='L114' name='L114' /><em class='comment'>// MSVC linker to bring in libtcmalloc, via the /INCLUDE linker flag.</em>
<a id='L115' name='L115' /><em class='comment'>// Without this, the linker will likely decide that libtcmalloc.dll</em>
<a id='L116' name='L116' /><em class='comment'>// doesn't add anything to the executable (since it does all its work</em>
<a id='L117' name='L117' /><em class='comment'>// through patching, which the linker can't see), and ignore it</em>
<a id='L118' name='L118' /><em class='comment'>// entirely.  (The name 'tcmalloc' is already reserved for a</em>
<a id='L119' name='L119' /><em class='comment'>// namespace.  I'd rather export a variable named "_tcmalloc", but I</em>
<a id='L120' name='L120' /><em class='comment'>// couldn't figure out how to get that to work.  This function exports</em>
<a id='L121' name='L121' /><em class='comment'>// the symbol "__tcmalloc".)</em>
<a id='L122' name='L122' /><strong class='reserved'>extern</strong> "C" <a href='../D/2076.html' title='Multiple defined in 25 places.'>PERFTOOLS_DLL_DECL</a> <strong class='reserved'>void</strong> <a href='../S/684.html#L123' title='Defined at 123 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>_tcmalloc</a>();
<a id='L123' name='L123' /><strong class='reserved'>void</strong> <a href='../S/684.html#L122' title='Refered from 122 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>_tcmalloc</a>() <em class='brace'>{</em> <em class='brace'>}</em>
<a id='L124' name='L124' />
<a id='L125' name='L125' /><em class='comment'>// This is the version needed for windows x64, which has a different</em>
<a id='L126' name='L126' /><em class='comment'>// decoration scheme which doesn't auto-add a leading underscore.</em>
<a id='L127' name='L127' /><strong class='reserved'>extern</strong> "C" <a href='../D/2076.html' title='Multiple defined in 25 places.'>PERFTOOLS_DLL_DECL</a> <strong class='reserved'>void</strong> <a href='../S/684.html#L128' title='Defined at 128 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>__tcmalloc</a>();
<a id='L128' name='L128' /><strong class='reserved'>void</strong> <a href='../S/684.html#L127' title='Refered from 127 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>__tcmalloc</a>() <em class='brace'>{</em> <em class='brace'>}</em>
<a id='L129' name='L129' />
<a id='L130' name='L130' /><strong class='reserved'>namespace</strong> <em class='brace'>{</em>    <em class='comment'>// most everything here is in an unnamed namespace</em>
<a id='L131' name='L131' />
<a id='L132' name='L132' /><strong class='reserved'>typedef</strong> <strong class='reserved'>void</strong> (*<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)();
<a id='L133' name='L133' />
<a id='L134' name='L134' /><strong class='reserved'>using</strong> <a href='../D/5094.html' title='Multiple defined in 5 places.'>sidestep</a>::<a href='../Y/649.html' title='Multiple used in 12 places.'>PreamblePatcher</a>;
<a id='L135' name='L135' />
<a id='L136' name='L136' /><strong class='reserved'>struct</strong> <a href='../S/684.html#L291' title='Defined at 291 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>ModuleEntryCopy</a>;   <em class='comment'>// defined below</em>
<a id='L137' name='L137' />
<a id='L138' name='L138' /><em class='comment'>// These functions are how we override the memory allocation</em>
<a id='L139' name='L139' /><em class='comment'>// functions, just like tcmalloc.cc and malloc_hook.cc do.</em>
<a id='L140' name='L140' />
<a id='L141' name='L141' /><em class='comment'>// This is information about the routines we're patching, for a given</em>
<a id='L142' name='L142' /><em class='comment'>// module that implements libc memory routines.  A single executable</em>
<a id='L143' name='L143' /><em class='comment'>// can have several libc implementations running about (in different</em>
<a id='L144' name='L144' /><em class='comment'>// .dll's), and we need to patch/unpatch them all.  This defines</em>
<a id='L145' name='L145' /><em class='comment'>// everything except the new functions we're patching in, which</em>
<a id='L146' name='L146' /><em class='comment'>// are defined in LibcFunctions, below.</em>
<a id='L147' name='L147' /><strong class='reserved'>class</strong> <a href='../R/1444.html' title='Multiple refered from 13 places.'>LibcInfo</a> <em class='brace'>{</em>
<a id='L148' name='L148' /> <strong class='reserved'>public</strong>:
<a id='L149' name='L149' />  LibcInfo() <em class='brace'>{</em>
<a id='L150' name='L150' />    <a href='../Y/3518.html' title='Multiple used in 105 places.'>memset</a>(<strong class='reserved'>this</strong>, 0, <strong class='reserved'>sizeof</strong>(*<strong class='reserved'>this</strong>));  <em class='comment'>// easiest way to initialize the array</em>
<a id='L151' name='L151' />  <em class='brace'>}</em>
<a id='L152' name='L152' />
<a id='L153' name='L153' />  <strong class='reserved'>bool</strong> <a href='../R/4368.html' title='Multiple refered from 3 places.'>patched</a>() <strong class='reserved'>const</strong> <em class='brace'>{</em> <strong class='reserved'>return</strong> <a href='../S/684.html#L221' title='Defined at 221 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>is_valid</a>(); <em class='brace'>}</em>
<a id='L154' name='L154' />  <strong class='reserved'>void</strong> <a href='../R/4647.html' title='Multiple refered from 3 places.'>set_is_valid</a>(<strong class='reserved'>bool</strong> <a href='../Y/1569.html' title='Multiple used in 469 places.'>b</a>) <em class='brace'>{</em> <a href='../Y/2927.html' title='Multiple used in 4 places.'>is_valid_</a> = <a href='../Y/1569.html' title='Multiple used in 469 places.'>b</a>; <em class='brace'>}</em>
<a id='L155' name='L155' />  <em class='comment'>// According to http://msdn.microsoft.com/en-us/library/ms684229(VS.85).aspx:</em>
<a id='L156' name='L156' />  <em class='comment'>// "The load address of a module (lpBaseOfDll) is the same as the HMODULE</em>
<a id='L157' name='L157' />  <em class='comment'>// value."</em>
<a id='L158' name='L158' />  <a href='../Y/351.html' title='Multiple used in 18 places.'>HMODULE</a> <a href='../S/684.html#L722' title='Refered from 722 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>hmodule</a>() <strong class='reserved'>const</strong> <em class='brace'>{</em>
<a id='L159' name='L159' />    <strong class='reserved'>return</strong> <strong class='reserved'>reinterpret_cast</strong>&lt;<a href='../Y/351.html' title='Multiple used in 18 places.'>HMODULE</a>&gt;(<strong class='reserved'>const_cast</strong>&lt;<strong class='reserved'>void</strong>*&gt;(<a href='../Y/3584.html' title='Multiple used in 4 places.'>module_base_address_</a>));
<a id='L160' name='L160' />  <em class='brace'>}</em>
<a id='L161' name='L161' />
<a id='L162' name='L162' />  <em class='comment'>// Populates all the windows_fn_[] vars based on our module info.</em>
<a id='L163' name='L163' />  <em class='comment'>// Returns false if windows_fn_ is all NULL's, because there's</em>
<a id='L164' name='L164' />  <em class='comment'>// nothing to patch.  Also populates the rest of the module_entry</em>
<a id='L165' name='L165' />  <em class='comment'>// info, such as the module's name.</em>
<a id='L166' name='L166' />  <strong class='reserved'>bool</strong> <a href='../Y/646.html' title='Multiple used in 4 places.'>PopulateWindowsFn</a>(<strong class='reserved'>const</strong> <a href='../S/684.html#L291' title='Defined at 291 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>ModuleEntryCopy</a>&amp; <a href='../Y/3588.html' title='Multiple used in 5 places.'>module_entry</a>);
<a id='L167' name='L167' />
<a id='L168' name='L168' /> <strong class='reserved'>protected</strong>:
<a id='L169' name='L169' />  <strong class='reserved'>void</strong> <a href='../S/684.html#L542' title='Refered from 542 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>CopyFrom</a>(<strong class='reserved'>const</strong> <a href='../S/684.html#L147' title='Defined at 147 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfo</a>&amp; <a href='../Y/5348.html' title='Multiple used in 6 places.'>that</a>) <em class='brace'>{</em>
<a id='L170' name='L170' />    <strong class='reserved'>if</strong> (<strong class='reserved'>this</strong> == &amp;<a href='../Y/5348.html' title='Multiple used in 6 places.'>that</a>)
<a id='L171' name='L171' />      <strong class='reserved'>return</strong>;
<a id='L172' name='L172' />    <strong class='reserved'>this</strong>-&gt;<a href='../Y/2927.html' title='Multiple used in 4 places.'>is_valid_</a> = <a href='../Y/5348.html' title='Multiple used in 6 places.'>that</a>.<a href='../Y/2927.html' title='Multiple used in 4 places.'>is_valid_</a>;
<a id='L173' name='L173' />    <a href='../Y/3502.html' title='Multiple used in 35 places.'>memcpy</a>(<strong class='reserved'>this</strong>-&gt;<a href='../Y/5688.html' title='Multiple used in 14 places.'>windows_fn_</a>, <a href='../Y/5348.html' title='Multiple used in 6 places.'>that</a>.<a href='../Y/5688.html' title='Multiple used in 14 places.'>windows_fn_</a>, <strong class='reserved'>sizeof</strong>(<a href='../Y/5688.html' title='Multiple used in 14 places.'>windows_fn_</a>));
<a id='L174' name='L174' />    <strong class='reserved'>this</strong>-&gt;<a href='../Y/3584.html' title='Multiple used in 4 places.'>module_base_address_</a> = <a href='../Y/5348.html' title='Multiple used in 6 places.'>that</a>.<a href='../Y/3584.html' title='Multiple used in 4 places.'>module_base_address_</a>;
<a id='L175' name='L175' />    <strong class='reserved'>this</strong>-&gt;<a href='../Y/3585.html' title='Multiple used in 3 places.'>module_base_size_</a> = <a href='../Y/5348.html' title='Multiple used in 6 places.'>that</a>.<a href='../Y/3585.html' title='Multiple used in 3 places.'>module_base_size_</a>;
<a id='L176' name='L176' />  <em class='brace'>}</em>
<a id='L177' name='L177' />
<a id='L178' name='L178' />  <strong class='reserved'>enum</strong> <em class='brace'>{</em>
<a id='L179' name='L179' />    kMalloc, <a href='../R/3715.html' title='Multiple refered from 8 places.'>kFree</a>, <a href='../S/684.html#L532' title='Refered from 532 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kRealloc</a>, kCalloc,
<a id='L180' name='L180' />    kNew, kNewArray, kDelete, kDeleteArray,
<a id='L181' name='L181' />    kNewNothrow, kNewArrayNothrow, kDeleteNothrow, kDeleteArrayNothrow,
<a id='L182' name='L182' />    <em class='comment'>// These are windows-only functions from malloc.h</em>
<a id='L183' name='L183' />    <a href='../R/3739.html' title='Multiple refered from 2 places.'>k_Msize</a>, k_Expand,
<a id='L184' name='L184' />    <a href='../R/3724.html' title='Multiple refered from 16 places.'>kNumFunctions</a>
<a id='L185' name='L185' />  <em class='brace'>}</em>;
<a id='L186' name='L186' />
<a id='L187' name='L187' />  <em class='comment'>// I'd like to put these together in a struct (perhaps in the</em>
<a id='L188' name='L188' />  <em class='comment'>// subclass, so we can put in perftools_fn_ as well), but vc8 seems</em>
<a id='L189' name='L189' />  <em class='comment'>// to have a bug where it doesn't initialize the struct properly if</em>
<a id='L190' name='L190' />  <em class='comment'>// we try to take the address of a function that's not yet loaded</em>
<a id='L191' name='L191' />  <em class='comment'>// from a dll, as is the common case for static_fn_.  So we need</em>
<a id='L192' name='L192' />  <em class='comment'>// each to be in its own array. :-(</em>
<a id='L193' name='L193' />  <strong class='reserved'>static</strong> <strong class='reserved'>const</strong> <strong class='reserved'>char</strong>* <strong class='reserved'>const</strong> <a href='../Y/2494.html' title='Multiple used in 4 places.'>function_name_</a>[<a href='../D/4122.html' title='Multiple defined in 2 places.'>kNumFunctions</a>];
<a id='L194' name='L194' />
<a id='L195' name='L195' />  <em class='comment'>// This function is only used when statically linking the binary.</em>
<a id='L196' name='L196' />  <em class='comment'>// In that case, loading malloc/etc from the dll (via</em>
<a id='L197' name='L197' />  <em class='comment'>// PatchOneModule) won't work, since there are no dlls.  Instead,</em>
<a id='L198' name='L198' />  <em class='comment'>// you just want to be taking the address of malloc/etc directly.</em>
<a id='L199' name='L199' />  <em class='comment'>// In the common, non-static-link case, these pointers will all be</em>
<a id='L200' name='L200' />  <em class='comment'>// NULL, since this initializer runs before msvcrt.dll is loaded.</em>
<a id='L201' name='L201' />  <strong class='reserved'>static</strong> <strong class='reserved'>const</strong> <a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a> <a href='../Y/5083.html' title='Multiple used in 3 places.'>static_fn_</a>[<a href='../D/4122.html' title='Multiple defined in 2 places.'>kNumFunctions</a>];
<a id='L202' name='L202' />
<a id='L203' name='L203' />  <em class='comment'>// This is the address of the function we are going to patch</em>
<a id='L204' name='L204' />  <em class='comment'>// (malloc, etc).  Other info about the function is in the</em>
<a id='L205' name='L205' />  <em class='comment'>// patch-specific subclasses, below.</em>
<a id='L206' name='L206' />  <a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a> <a href='../Y/5688.html' title='Multiple used in 14 places.'>windows_fn_</a>[<a href='../D/4122.html' title='Multiple defined in 2 places.'>kNumFunctions</a>];
<a id='L207' name='L207' />
<a id='L208' name='L208' />  <em class='comment'>// This is set to true when this structure is initialized (because</em>
<a id='L209' name='L209' />  <em class='comment'>// we're patching a new library) and set to false when it's</em>
<a id='L210' name='L210' />  <em class='comment'>// uninitialized (because we've freed that library).</em>
<a id='L211' name='L211' />  <strong class='reserved'>bool</strong> <a href='../Y/2927.html' title='Multiple used in 4 places.'>is_valid_</a>;
<a id='L212' name='L212' />
<a id='L213' name='L213' />  <strong class='reserved'>const</strong> <strong class='reserved'>void</strong> *<a href='../Y/3584.html' title='Multiple used in 4 places.'>module_base_address_</a>;
<a id='L214' name='L214' />  <a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a> <a href='../Y/3585.html' title='Multiple used in 3 places.'>module_base_size_</a>;
<a id='L215' name='L215' />
<a id='L216' name='L216' /> <strong class='reserved'>public</strong>:
<a id='L217' name='L217' />  <em class='comment'>// These shouldn't have to be public, since only subclasses of</em>
<a id='L218' name='L218' />  <em class='comment'>// LibcInfo need it, but they do.  Maybe something to do with</em>
<a id='L219' name='L219' />  <em class='comment'>// templates.  Shrug.  I hide them down here so users won't see</em>
<a id='L220' name='L220' />  <em class='comment'>// them. :-)  (OK, I also need to define ctrgProcAddress late.)</em>
<a id='L221' name='L221' />  <strong class='reserved'>bool</strong> <a href='../R/3704.html' title='Multiple refered from 11 places.'>is_valid</a>() <strong class='reserved'>const</strong> <em class='brace'>{</em> <strong class='reserved'>return</strong> <a href='../Y/2927.html' title='Multiple used in 4 places.'>is_valid_</a>; <em class='brace'>}</em>
<a id='L222' name='L222' />  <a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a> <a href='../R/5130.html' title='Multiple refered from 5 places.'>windows_fn</a>(<strong class='reserved'>int</strong> <a href='../Y/2763.html' title='Multiple used in 6 places.'>ifunction</a>) <strong class='reserved'>const</strong> <em class='brace'>{</em>
<a id='L223' name='L223' />    <strong class='reserved'>return</strong> <a href='../Y/5688.html' title='Multiple used in 14 places.'>windows_fn_</a>[<a href='../Y/2763.html' title='Multiple used in 6 places.'>ifunction</a>];
<a id='L224' name='L224' />  <em class='brace'>}</em>
<a id='L225' name='L225' />  <em class='comment'>// These three are needed by ModuleEntryCopy.</em>
<a id='L226' name='L226' />  <strong class='reserved'>static</strong> <strong class='reserved'>const</strong> <strong class='reserved'>int</strong> <a href='../Y/1907.html' title='Multiple used in 2 places.'>ctrgProcAddress</a> = <a href='../D/4122.html' title='Multiple defined in 2 places.'>kNumFunctions</a>;
<a id='L227' name='L227' />  <strong class='reserved'>static</strong> <a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a> <a href='../S/684.html#L303' title='Refered from 303 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>static_fn</a>(<strong class='reserved'>int</strong> <a href='../Y/2763.html' title='Multiple used in 6 places.'>ifunction</a>) <em class='brace'>{</em>
<a id='L228' name='L228' />    <strong class='reserved'>return</strong> <a href='../Y/5083.html' title='Multiple used in 3 places.'>static_fn_</a>[<a href='../Y/2763.html' title='Multiple used in 6 places.'>ifunction</a>];
<a id='L229' name='L229' />  <em class='brace'>}</em>
<a id='L230' name='L230' />  <strong class='reserved'>static</strong> <strong class='reserved'>const</strong> <strong class='reserved'>char</strong>* <strong class='reserved'>const</strong> <a href='../R/3460.html' title='Multiple refered from 13 places.'>function_name</a>(<strong class='reserved'>int</strong> <a href='../Y/2763.html' title='Multiple used in 6 places.'>ifunction</a>) <em class='brace'>{</em>
<a id='L231' name='L231' />    <strong class='reserved'>return</strong> <a href='../Y/2494.html' title='Multiple used in 4 places.'>function_name_</a>[<a href='../Y/2763.html' title='Multiple used in 6 places.'>ifunction</a>];
<a id='L232' name='L232' />  <em class='brace'>}</em>
<a id='L233' name='L233' /><em class='brace'>}</em>;
<a id='L234' name='L234' />
<a id='L235' name='L235' /><em class='comment'>// Template trickiness: logically, a LibcInfo would include</em>
<a id='L236' name='L236' /><em class='comment'>// Windows_malloc_, origstub_malloc_, and Perftools_malloc_: for a</em>
<a id='L237' name='L237' /><em class='comment'>// given module, these three go together.  And in fact,</em>
<a id='L238' name='L238' /><em class='comment'>// Perftools_malloc_ may need to call origstub_malloc_, which means we</em>
<a id='L239' name='L239' /><em class='comment'>// either need to change Perftools_malloc_ to take origstub_malloc_ as</em>
<a id='L240' name='L240' /><em class='comment'>// an arugment -- unfortunately impossible since it needs to keep the</em>
<a id='L241' name='L241' /><em class='comment'>// same API as normal malloc -- or we need to write a different</em>
<a id='L242' name='L242' /><em class='comment'>// version of Perftools_malloc_ for each LibcInfo instance we create.</em>
<a id='L243' name='L243' /><em class='comment'>// We choose the second route, and use templates to implement it (we</em>
<a id='L244' name='L244' /><em class='comment'>// could have also used macros).  So to get multiple versions</em>
<a id='L245' name='L245' /><em class='comment'>// of the struct, we say "struct&lt;1&gt; var1; struct&lt;2&gt; var2;".  The price</em>
<a id='L246' name='L246' /><em class='comment'>// we pay is some code duplication, and more annoying, each instance</em>
<a id='L247' name='L247' /><em class='comment'>// of this var is a separate type.</em>
<a id='L248' name='L248' /><strong class='reserved'>template</strong>&lt;<strong class='reserved'>int</strong>&gt; <strong class='reserved'>class</strong> <a href='../R/1445.html' title='Multiple refered from 27 places.'>LibcInfoWithPatchFunctions</a> : <strong class='reserved'>public</strong> <a href='../S/684.html#L147' title='Defined at 147 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfo</a> <em class='brace'>{</em>
<a id='L249' name='L249' /> <strong class='reserved'>public</strong>:
<a id='L250' name='L250' />  <em class='comment'>// me_info should have had PopulateWindowsFn() called on it, so the</em>
<a id='L251' name='L251' />  <em class='comment'>// module_* vars and windows_fn_ are set up.</em>
<a id='L252' name='L252' />  <strong class='reserved'>bool</strong> <a href='../Y/636.html' title='Multiple used in 18 places.'>Patch</a>(<strong class='reserved'>const</strong> <a href='../S/684.html#L147' title='Defined at 147 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfo</a>&amp; <a href='../Y/3485.html' title='Multiple used in 12 places.'>me_info</a>);
<a id='L253' name='L253' />  <strong class='reserved'>void</strong> <a href='../S/687.html#L253' title='Defined at 253 in third_party/google-perftools-1.8.3/src/windows/preamble_patcher.cc.'>Unpatch</a>();
<a id='L254' name='L254' />
<a id='L255' name='L255' /> <strong class='reserved'>private</strong>:
<a id='L256' name='L256' />  <em class='comment'>// This holds the original function contents after we patch the function.</em>
<a id='L257' name='L257' />  <em class='comment'>// This has to be defined static in the subclass, because the perftools_fns</em>
<a id='L258' name='L258' />  <em class='comment'>// reference origstub_fn_.</em>
<a id='L259' name='L259' />  <strong class='reserved'>static</strong> <a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a> <a href='../Y/4041.html' title='Multiple used in 15 places.'>origstub_fn_</a>[<a href='../D/4122.html' title='Multiple defined in 2 places.'>kNumFunctions</a>];
<a id='L260' name='L260' />
<a id='L261' name='L261' />  <em class='comment'>// This is the function we want to patch in</em>
<a id='L262' name='L262' />  <strong class='reserved'>static</strong> <strong class='reserved'>const</strong> <a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a> <a href='../Y/4147.html' title='Multiple used in 5 places.'>perftools_fn_</a>[<a href='../D/4122.html' title='Multiple defined in 2 places.'>kNumFunctions</a>];
<a id='L263' name='L263' />
<a id='L264' name='L264' />  <strong class='reserved'>static</strong> <strong class='reserved'>void</strong>* <a href='../S/684.html#L792' title='Defined at 792 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_malloc</a>(<a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a> <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>) <a href='../D/3265.html' title='Multiple defined in 10 places.'>__THROW</a>;
<a id='L265' name='L265' />  <strong class='reserved'>static</strong> <strong class='reserved'>void</strong> <a href='../S/684.html#L799' title='Defined at 799 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_free</a>(<strong class='reserved'>void</strong>* <a href='../Y/4374.html' title='Multiple used in 1186 places.'>ptr</a>) <a href='../D/3265.html' title='Multiple defined in 10 places.'>__THROW</a>;
<a id='L266' name='L266' />  <strong class='reserved'>static</strong> <strong class='reserved'>void</strong>* <a href='../S/684.html#L809' title='Defined at 809 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_realloc</a>(<strong class='reserved'>void</strong>* <a href='../Y/4374.html' title='Multiple used in 1186 places.'>ptr</a>, <a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a> <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>) <a href='../D/3265.html' title='Multiple defined in 10 places.'>__THROW</a>;
<a id='L267' name='L267' />  <strong class='reserved'>static</strong> <strong class='reserved'>void</strong>* <a href='../S/684.html#L829' title='Defined at 829 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_calloc</a>(<a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a> <a href='../Y/3824.html' title='Multiple used in 4 places.'>nmemb</a>, <a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a> <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>) <a href='../D/3265.html' title='Multiple defined in 10 places.'>__THROW</a>;
<a id='L268' name='L268' />  <strong class='reserved'>static</strong> <strong class='reserved'>void</strong>* <a href='../S/684.html#L837' title='Defined at 837 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_new</a>(<a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a> <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>);
<a id='L269' name='L269' />  <strong class='reserved'>static</strong> <strong class='reserved'>void</strong>* <a href='../S/684.html#L844' title='Defined at 844 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_newarray</a>(<a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a> <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>);
<a id='L270' name='L270' />  <strong class='reserved'>static</strong> <strong class='reserved'>void</strong> <a href='../S/684.html#L851' title='Defined at 851 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_delete</a>(<strong class='reserved'>void</strong> *<a href='../Y/4374.html' title='Multiple used in 1186 places.'>ptr</a>);
<a id='L271' name='L271' />  <strong class='reserved'>static</strong> <strong class='reserved'>void</strong> <a href='../S/684.html#L857' title='Defined at 857 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_deletearray</a>(<strong class='reserved'>void</strong> *<a href='../Y/4374.html' title='Multiple used in 1186 places.'>ptr</a>);
<a id='L272' name='L272' />  <strong class='reserved'>static</strong> <strong class='reserved'>void</strong>* <a href='../S/684.html#L863' title='Defined at 863 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_new_nothrow</a>(<a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a> <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>,
<a id='L273' name='L273' />                                     <strong class='reserved'>const</strong> <a href='../Y/5100.html' title='Multiple used in 181 places.'>std</a>::<a href='../Y/3844.html' title='Multiple used in 48 places.'>nothrow_t</a>&amp;) <a href='../D/3265.html' title='Multiple defined in 10 places.'>__THROW</a>;
<a id='L274' name='L274' />  <strong class='reserved'>static</strong> <strong class='reserved'>void</strong>* <a href='../S/684.html#L871' title='Defined at 871 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_newarray_nothrow</a>(<a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a> <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>,
<a id='L275' name='L275' />                                          <strong class='reserved'>const</strong> <a href='../Y/5100.html' title='Multiple used in 181 places.'>std</a>::<a href='../Y/3844.html' title='Multiple used in 48 places.'>nothrow_t</a>&amp;) <a href='../D/3265.html' title='Multiple defined in 10 places.'>__THROW</a>;
<a id='L276' name='L276' />  <strong class='reserved'>static</strong> <strong class='reserved'>void</strong> <a href='../S/684.html#L879' title='Defined at 879 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_delete_nothrow</a>(<strong class='reserved'>void</strong> *<a href='../Y/4374.html' title='Multiple used in 1186 places.'>ptr</a>,
<a id='L277' name='L277' />                                       <strong class='reserved'>const</strong> <a href='../Y/5100.html' title='Multiple used in 181 places.'>std</a>::<a href='../Y/3844.html' title='Multiple used in 48 places.'>nothrow_t</a>&amp;) <a href='../D/3265.html' title='Multiple defined in 10 places.'>__THROW</a>;
<a id='L278' name='L278' />  <strong class='reserved'>static</strong> <strong class='reserved'>void</strong> <a href='../S/684.html#L886' title='Defined at 886 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_deletearray_nothrow</a>(<strong class='reserved'>void</strong> *<a href='../Y/4374.html' title='Multiple used in 1186 places.'>ptr</a>,
<a id='L279' name='L279' />                                            <strong class='reserved'>const</strong> <a href='../Y/5100.html' title='Multiple used in 181 places.'>std</a>::<a href='../Y/3844.html' title='Multiple used in 48 places.'>nothrow_t</a>&amp;) <a href='../D/3265.html' title='Multiple defined in 10 places.'>__THROW</a>;
<a id='L280' name='L280' />  <strong class='reserved'>static</strong> <a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a> <a href='../S/684.html#L902' title='Defined at 902 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools__msize</a>(<strong class='reserved'>void</strong> *<a href='../Y/4374.html' title='Multiple used in 1186 places.'>ptr</a>) <a href='../D/3265.html' title='Multiple defined in 10 places.'>__THROW</a>;
<a id='L281' name='L281' />  <strong class='reserved'>static</strong> <strong class='reserved'>void</strong>* <a href='../S/684.html#L910' title='Defined at 910 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools__expand</a>(<strong class='reserved'>void</strong> *<a href='../Y/4374.html' title='Multiple used in 1186 places.'>ptr</a>, <a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a> <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>) <a href='../D/3265.html' title='Multiple defined in 10 places.'>__THROW</a>;
<a id='L282' name='L282' />  <em class='comment'>// malloc.h also defines these functions:</em>
<a id='L283' name='L283' />  <em class='comment'>//   _aligned_malloc, _aligned_free,</em>
<a id='L284' name='L284' />  <em class='comment'>//   _recalloc, _aligned_offset_malloc, _aligned_realloc, _aligned_recalloc</em>
<a id='L285' name='L285' />  <em class='comment'>//   _aligned_offset_realloc, _aligned_offset_recalloc, _malloca, _freea</em>
<a id='L286' name='L286' />  <em class='comment'>// But they seem pretty obscure, and I'm fine not overriding them for now.</em>
<a id='L287' name='L287' />  <em class='comment'>// It may be they all call into malloc/free anyway.</em>
<a id='L288' name='L288' /><em class='brace'>}</em>;
<a id='L289' name='L289' />
<a id='L290' name='L290' /><em class='comment'>// This is a subset of MODDULEENTRY32, that we need for patching.</em>
<a id='L291' name='L291' /><strong class='reserved'>struct</strong> <a href='../R/1683.html' title='Multiple refered from 9 places.'>ModuleEntryCopy</a> <em class='brace'>{</em>
<a id='L292' name='L292' />  <a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a>  <a href='../Y/3571.html' title='Multiple used in 6 places.'>modBaseAddr</a>;     <em class='comment'>// the same as hmodule</em>
<a id='L293' name='L293' />  <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a>   <a href='../Y/3572.html' title='Multiple used in 5 places.'>modBaseSize</a>;
<a id='L294' name='L294' />  <em class='comment'>// This is not part of MODDULEENTRY32, but is needed to avoid making</em>
<a id='L295' name='L295' />  <em class='comment'>// windows syscalls while we're holding patch_all_modules_lock (see</em>
<a id='L296' name='L296' />  <em class='comment'>// lock-inversion comments at patch_all_modules_lock definition, below).</em>
<a id='L297' name='L297' />  <a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a> <a href='../Y/4559.html' title='Multiple used in 7 places.'>rgProcAddresses</a>[<a href='../S/684.html#L147' title='Defined at 147 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfo</a>::<a href='../Y/1907.html' title='Multiple used in 2 places.'>ctrgProcAddress</a>];
<a id='L298' name='L298' />
<a id='L299' name='L299' />  <a href='../S/684.html#L291' title='Defined at 291 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>ModuleEntryCopy</a>() <em class='brace'>{</em>
<a id='L300' name='L300' />    <a href='../Y/3571.html' title='Multiple used in 6 places.'>modBaseAddr</a> = <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>;
<a id='L301' name='L301' />    <a href='../Y/3572.html' title='Multiple used in 5 places.'>modBaseSize</a> = 0;
<a id='L302' name='L302' />    <strong class='reserved'>for</strong> (<strong class='reserved'>int</strong> <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> = 0; <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> &lt; <strong class='reserved'>sizeof</strong>(<a href='../Y/4559.html' title='Multiple used in 7 places.'>rgProcAddresses</a>)/<strong class='reserved'>sizeof</strong>(*<a href='../Y/4559.html' title='Multiple used in 7 places.'>rgProcAddresses</a>); <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>++)
<a id='L303' name='L303' />      <a href='../Y/4559.html' title='Multiple used in 7 places.'>rgProcAddresses</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>] = <a href='../S/684.html#L147' title='Defined at 147 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfo</a>::<a href='../S/684.html#L227' title='Defined at 227 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>static_fn</a>(<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>);
<a id='L304' name='L304' />  <em class='brace'>}</em>
<a id='L305' name='L305' />  <a href='../S/684.html#L291' title='Defined at 291 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>ModuleEntryCopy</a>(<strong class='reserved'>const</strong> <a href='../Y/478.html' title='Multiple used in 2 places.'>MODULEINFO</a>&amp; <a href='../Y/3529.html' title='Multiple used in 8 places.'>mi</a>) <em class='brace'>{</em>
<a id='L306' name='L306' />    <strong class='reserved'>this</strong>-&gt;<a href='../Y/3571.html' title='Multiple used in 6 places.'>modBaseAddr</a> = <a href='../Y/3529.html' title='Multiple used in 8 places.'>mi</a>.<a href='../Y/3343.html' title='Multiple used in 3 places.'>lpBaseOfDll</a>;
<a id='L307' name='L307' />    <strong class='reserved'>this</strong>-&gt;<a href='../Y/3572.html' title='Multiple used in 5 places.'>modBaseSize</a> = <a href='../Y/3529.html' title='Multiple used in 8 places.'>mi</a>.<a href='../Y/798.html' title='Multiple used in 2 places.'>SizeOfImage</a>;
<a id='L308' name='L308' />    <a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a> <a href='../Y/3573.html' title='Multiple used in 2 places.'>modEndAddr</a> = (<strong class='reserved'>char</strong>*)<a href='../Y/3529.html' title='Multiple used in 8 places.'>mi</a>.<a href='../Y/3343.html' title='Multiple used in 3 places.'>lpBaseOfDll</a> + <a href='../Y/3529.html' title='Multiple used in 8 places.'>mi</a>.<a href='../Y/798.html' title='Multiple used in 2 places.'>SizeOfImage</a>;
<a id='L309' name='L309' />    <strong class='reserved'>for</strong> (<strong class='reserved'>int</strong> <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> = 0; <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> &lt; <strong class='reserved'>sizeof</strong>(<a href='../Y/4559.html' title='Multiple used in 7 places.'>rgProcAddresses</a>)/<strong class='reserved'>sizeof</strong>(*<a href='../Y/4559.html' title='Multiple used in 7 places.'>rgProcAddresses</a>); <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>++) <em class='brace'>{</em>
<a id='L310' name='L310' />      <a href='../Y/183.html' title='Multiple used in 2 places.'>FARPROC</a> <a href='../Y/5300.html' title='Multiple used in 42 places.'>target</a> = ::<a href='../Y/313.html' title='Multiple used in 4 places.'>GetProcAddress</a>(
<a id='L311' name='L311' />          <strong class='reserved'>reinterpret_cast</strong>&lt;<strong class='reserved'>const</strong> <a href='../Y/351.html' title='Multiple used in 18 places.'>HMODULE</a>&gt;(<a href='../Y/3529.html' title='Multiple used in 8 places.'>mi</a>.<a href='../Y/3343.html' title='Multiple used in 3 places.'>lpBaseOfDll</a>),
<a id='L312' name='L312' />          <a href='../S/684.html#L147' title='Defined at 147 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfo</a>::<a href='../S/684.html#L230' title='Defined at 230 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>function_name</a>(<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>));
<a id='L313' name='L313' />      <em class='comment'>// Sometimes a DLL forwards a function to a function in another</em>
<a id='L314' name='L314' />      <em class='comment'>// DLL.  We don't want to patch those forwarded functions --</em>
<a id='L315' name='L315' />      <em class='comment'>// they'll get patched when the other DLL is processed.</em>
<a id='L316' name='L316' />      <strong class='reserved'>if</strong> (<a href='../Y/5300.html' title='Multiple used in 42 places.'>target</a> &gt;= <a href='../Y/3571.html' title='Multiple used in 6 places.'>modBaseAddr</a> &amp;&amp; <a href='../Y/5300.html' title='Multiple used in 42 places.'>target</a> &lt; <a href='../Y/3573.html' title='Multiple used in 2 places.'>modEndAddr</a>)
<a id='L317' name='L317' />        <a href='../Y/4559.html' title='Multiple used in 7 places.'>rgProcAddresses</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>] = (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)<a href='../Y/5300.html' title='Multiple used in 42 places.'>target</a>;
<a id='L318' name='L318' />      <strong class='reserved'>else</strong>
<a id='L319' name='L319' />        <a href='../Y/4559.html' title='Multiple used in 7 places.'>rgProcAddresses</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>] = (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)<a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>;
<a id='L320' name='L320' />    <em class='brace'>}</em>
<a id='L321' name='L321' />  <em class='brace'>}</em>
<a id='L322' name='L322' /><em class='brace'>}</em>;
<a id='L323' name='L323' />
<a id='L324' name='L324' /><em class='comment'>// This class is easier because there's only one of them.</em>
<a id='L325' name='L325' /><strong class='reserved'>class</strong> <a href='../R/2693.html' title='Multiple refered from 12 places.'>WindowsInfo</a> <em class='brace'>{</em>
<a id='L326' name='L326' /> <strong class='reserved'>public</strong>:
<a id='L327' name='L327' />  <strong class='reserved'>void</strong> <a href='../Y/636.html' title='Multiple used in 18 places.'>Patch</a>();
<a id='L328' name='L328' />  <strong class='reserved'>void</strong> <a href='../S/687.html#L253' title='Defined at 253 in third_party/google-perftools-1.8.3/src/windows/preamble_patcher.cc.'>Unpatch</a>();
<a id='L329' name='L329' />
<a id='L330' name='L330' /> <strong class='reserved'>private</strong>:
<a id='L331' name='L331' />  <em class='comment'>// TODO(csilvers): should we be patching GlobalAlloc/LocalAlloc instead,</em>
<a id='L332' name='L332' />  <em class='comment'>//                 for pre-XP systems?</em>
<a id='L333' name='L333' />  <strong class='reserved'>enum</strong> <em class='brace'>{</em>
<a id='L334' name='L334' />    <a href='../S/684.html#L918' title='Refered from 918 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kHeapAlloc</a>, <a href='../S/684.html#L928' title='Refered from 928 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kHeapFree</a>, <a href='../S/684.html#L937' title='Refered from 937 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kVirtualAllocEx</a>, <a href='../S/684.html#L948' title='Refered from 948 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kVirtualFreeEx</a>,
<a id='L335' name='L335' />    <a href='../S/684.html#L959' title='Refered from 959 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kMapViewOfFileEx</a>, <a href='../S/684.html#L969' title='Refered from 969 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kUnmapViewOfFile</a>, <a href='../S/684.html#L996' title='Refered from 996 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kLoadLibraryExW</a>, <a href='../S/684.html#L1008' title='Refered from 1008 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kFreeLibrary</a>,
<a id='L336' name='L336' />    <a href='../R/3724.html' title='Multiple refered from 16 places.'>kNumFunctions</a>
<a id='L337' name='L337' />  <em class='brace'>}</em>;
<a id='L338' name='L338' />
<a id='L339' name='L339' />  <strong class='reserved'>struct</strong> <a href='../R/702.html' title='Multiple refered from 2 places.'>FunctionInfo</a> <em class='brace'>{</em>
<a id='L340' name='L340' />    <strong class='reserved'>const</strong> <strong class='reserved'>char</strong>* <strong class='reserved'>const</strong> <a href='../Y/3665.html' title='Multiple used in 438 places.'>name</a>;          <em class='comment'>// name of fn in a module (eg "malloc")</em>
<a id='L341' name='L341' />    <a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a> <a href='../S/684.html#L222' title='Defined at 222 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>windows_fn</a>;         <em class='comment'>// the fn whose name we call (&amp;malloc)</em>
<a id='L342' name='L342' />    <a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a> <a href='../Y/4040.html' title='Multiple used in 13 places.'>origstub_fn</a>;        <em class='comment'>// original fn contents after we patch</em>
<a id='L343' name='L343' />    <strong class='reserved'>const</strong> <a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a> <a href='../Y/4146.html' title='Multiple used in 3 places.'>perftools_fn</a>; <em class='comment'>// fn we want to patch in</em>
<a id='L344' name='L344' />  <em class='brace'>}</em>;
<a id='L345' name='L345' />
<a id='L346' name='L346' />  <strong class='reserved'>static</strong> <a href='../S/684.html#L339' title='Defined at 339 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>FunctionInfo</a> <a href='../Y/2493.html' title='Multiple used in 20 places.'>function_info_</a>[<a href='../D/4122.html' title='Multiple defined in 2 places.'>kNumFunctions</a>];
<a id='L347' name='L347' />
<a id='L348' name='L348' />  <em class='comment'>// A Windows-API equivalent of malloc and free</em>
<a id='L349' name='L349' />  <strong class='reserved'>static</strong> <a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a> <a href='../Y/926.html' title='Multiple used in 29 places.'>WINAPI</a> <a href='../S/684.html#L915' title='Defined at 915 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_HeapAlloc</a>(<a href='../Y/331.html' title='Multiple used in 28 places.'>HANDLE</a> <a href='../Y/2609.html' title='Multiple used in 6 places.'>hHeap</a>, <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a> <a href='../Y/2125.html' title='Multiple used in 9 places.'>dwFlags</a>,
<a id='L350' name='L350' />                                           <a href='../Y/117.html' title='Multiple used in 4 places.'>DWORD_PTR</a> <a href='../Y/2121.html' title='Multiple used in 4 places.'>dwBytes</a>);
<a id='L351' name='L351' />  <strong class='reserved'>static</strong> <a href='../S/347.html#L62' title='Defined at 62 in src/lmntal.h.'>BOOL</a> <a href='../Y/926.html' title='Multiple used in 29 places.'>WINAPI</a> <a href='../S/684.html#L924' title='Defined at 924 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_HeapFree</a>(<a href='../Y/331.html' title='Multiple used in 28 places.'>HANDLE</a> <a href='../Y/2609.html' title='Multiple used in 6 places.'>hHeap</a>, <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a> <a href='../Y/2125.html' title='Multiple used in 9 places.'>dwFlags</a>,
<a id='L352' name='L352' />                                        <a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a> <a href='../Y/3345.html' title='Multiple used in 4 places.'>lpMem</a>);
<a id='L353' name='L353' />  <em class='comment'>// A Windows-API equivalent of mmap and munmap, for "anonymous regions"</em>
<a id='L354' name='L354' />  <strong class='reserved'>static</strong> <a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a> <a href='../Y/926.html' title='Multiple used in 29 places.'>WINAPI</a> <a href='../S/684.html#L932' title='Defined at 932 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_VirtualAllocEx</a>(<a href='../Y/331.html' title='Multiple used in 28 places.'>HANDLE</a> <a href='../Y/4278.html' title='Multiple used in 32 places.'>process</a>, <a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a> <a href='../Y/1411.html' title='Multiple used in 58 places.'>address</a>,
<a id='L355' name='L355' />                                                <a href='../Y/733.html' title='Multiple used in 9 places.'>SIZE_T</a> <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>, <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a> <a href='../Y/5486.html' title='Multiple used in 318 places.'>type</a>,
<a id='L356' name='L356' />                                                <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a> <a href='../Y/4327.html' title='Multiple used in 4 places.'>protect</a>);
<a id='L357' name='L357' />  <strong class='reserved'>static</strong> <a href='../S/347.html#L62' title='Defined at 62 in src/lmntal.h.'>BOOL</a> <a href='../Y/926.html' title='Multiple used in 29 places.'>WINAPI</a> <a href='../S/684.html#L944' title='Defined at 944 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_VirtualFreeEx</a>(<a href='../Y/331.html' title='Multiple used in 28 places.'>HANDLE</a> <a href='../Y/4278.html' title='Multiple used in 32 places.'>process</a>, <a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a> <a href='../Y/1411.html' title='Multiple used in 58 places.'>address</a>,
<a id='L358' name='L358' />                                             <a href='../Y/733.html' title='Multiple used in 9 places.'>SIZE_T</a> <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>, <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a> <a href='../Y/5486.html' title='Multiple used in 318 places.'>type</a>);
<a id='L359' name='L359' />  <em class='comment'>// A Windows-API equivalent of mmap and munmap, for actual files</em>
<a id='L360' name='L360' />  <strong class='reserved'>static</strong> <a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a> <a href='../Y/926.html' title='Multiple used in 29 places.'>WINAPI</a> <a href='../S/684.html#L952' title='Defined at 952 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_MapViewOfFileEx</a>(<a href='../Y/331.html' title='Multiple used in 28 places.'>HANDLE</a> <a href='../Y/2607.html' title='Multiple used in 3 places.'>hFileMappingObject</a>,
<a id='L361' name='L361' />                                                 <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a> <a href='../Y/2122.html' title='Multiple used in 3 places.'>dwDesiredAccess</a>,
<a id='L362' name='L362' />                                                 <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a> <a href='../Y/2123.html' title='Multiple used in 3 places.'>dwFileOffsetHigh</a>,
<a id='L363' name='L363' />                                                 <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a> <a href='../Y/2124.html' title='Multiple used in 3 places.'>dwFileOffsetLow</a>,
<a id='L364' name='L364' />                                                 <a href='../Y/733.html' title='Multiple used in 9 places.'>SIZE_T</a> <a href='../Y/2126.html' title='Multiple used in 4 places.'>dwNumberOfBytesToMap</a>,
<a id='L365' name='L365' />                                                 <a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a> <a href='../Y/3342.html' title='Multiple used in 7 places.'>lpBaseAddress</a>);
<a id='L366' name='L366' />  <strong class='reserved'>static</strong> <a href='../S/347.html#L62' title='Defined at 62 in src/lmntal.h.'>BOOL</a> <a href='../Y/926.html' title='Multiple used in 29 places.'>WINAPI</a> <a href='../S/684.html#L966' title='Defined at 966 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_UnmapViewOfFile</a>(<a href='../Y/431.html' title='Multiple used in 3 places.'>LPCVOID</a> <a href='../Y/3342.html' title='Multiple used in 7 places.'>lpBaseAddress</a>);
<a id='L367' name='L367' />  <em class='comment'>// We don't need the other 3 variants because they all call this one. */</em>
<a id='L368' name='L368' />  <strong class='reserved'>static</strong> <a href='../Y/351.html' title='Multiple used in 18 places.'>HMODULE</a> <a href='../Y/926.html' title='Multiple used in 29 places.'>WINAPI</a> <a href='../S/684.html#L983' title='Defined at 983 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_LoadLibraryExW</a>(<a href='../Y/432.html' title='Multiple used in 4 places.'>LPCWSTR</a> <a href='../Y/3344.html' title='Multiple used in 4 places.'>lpFileName</a>,
<a id='L369' name='L369' />                                                 <a href='../Y/331.html' title='Multiple used in 28 places.'>HANDLE</a> <a href='../Y/2606.html' title='Multiple used in 3 places.'>hFile</a>,
<a id='L370' name='L370' />                                                 <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a> <a href='../Y/2125.html' title='Multiple used in 9 places.'>dwFlags</a>);
<a id='L371' name='L371' />  <strong class='reserved'>static</strong> <a href='../S/347.html#L62' title='Defined at 62 in src/lmntal.h.'>BOOL</a> <a href='../Y/926.html' title='Multiple used in 29 places.'>WINAPI</a> <a href='../S/684.html#L1006' title='Defined at 1006 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_FreeLibrary</a>(<a href='../Y/351.html' title='Multiple used in 18 places.'>HMODULE</a> <a href='../Y/2610.html' title='Multiple used in 5 places.'>hLibModule</a>);
<a id='L372' name='L372' /><em class='brace'>}</em>;
<a id='L373' name='L373' />
<a id='L374' name='L374' /><em class='comment'>// If you run out, just add a few more to the array.  You'll also need</em>
<a id='L375' name='L375' /><em class='comment'>// to update the switch statement in PatchOneModule(), and the list in</em>
<a id='L376' name='L376' /><em class='comment'>// UnpatchWindowsFunctions().</em>
<a id='L377' name='L377' /><em class='comment'>// main_executable and main_executable_windows are two windows into</em>
<a id='L378' name='L378' /><em class='comment'>// the same executable.  One is responsible for patching the libc</em>
<a id='L379' name='L379' /><em class='comment'>// routines that live in the main executable (if any) to use tcmalloc;</em>
<a id='L380' name='L380' /><em class='comment'>// the other is responsible for patching the windows routines like</em>
<a id='L381' name='L381' /><em class='comment'>// HeapAlloc/etc to use tcmalloc.</em>
<a id='L382' name='L382' /><strong class='reserved'>static</strong> <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;0&gt; <a href='../Y/3382.html' title='Multiple used in 6 places.'>main_executable</a>;
<a id='L383' name='L383' /><strong class='reserved'>static</strong> <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;1&gt; <a href='../Y/3225.html' title='Multiple used in 4 places.'>libc1</a>;
<a id='L384' name='L384' /><strong class='reserved'>static</strong> <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;2&gt; <a href='../Y/3226.html' title='Multiple used in 4 places.'>libc2</a>;
<a id='L385' name='L385' /><strong class='reserved'>static</strong> <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;3&gt; <a href='../Y/3227.html' title='Multiple used in 4 places.'>libc3</a>;
<a id='L386' name='L386' /><strong class='reserved'>static</strong> <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;4&gt; <a href='../Y/3228.html' title='Multiple used in 4 places.'>libc4</a>;
<a id='L387' name='L387' /><strong class='reserved'>static</strong> <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;5&gt; <a href='../Y/3229.html' title='Multiple used in 4 places.'>libc5</a>;
<a id='L388' name='L388' /><strong class='reserved'>static</strong> <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;6&gt; <a href='../Y/3230.html' title='Multiple used in 4 places.'>libc6</a>;
<a id='L389' name='L389' /><strong class='reserved'>static</strong> <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;7&gt; <a href='../Y/3231.html' title='Multiple used in 4 places.'>libc7</a>;
<a id='L390' name='L390' /><strong class='reserved'>static</strong> <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;8&gt; <a href='../Y/3232.html' title='Multiple used in 4 places.'>libc8</a>;
<a id='L391' name='L391' /><strong class='reserved'>static</strong> <a href='../S/684.html#L147' title='Defined at 147 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfo</a>* <a href='../Y/2516.html' title='Multiple used in 10 places.'>g_module_libcs</a>[] = <em class='brace'>{</em>
<a id='L392' name='L392' />  &amp;<a href='../Y/3225.html' title='Multiple used in 4 places.'>libc1</a>, &amp;<a href='../Y/3226.html' title='Multiple used in 4 places.'>libc2</a>, &amp;<a href='../Y/3227.html' title='Multiple used in 4 places.'>libc3</a>, &amp;<a href='../Y/3228.html' title='Multiple used in 4 places.'>libc4</a>, &amp;<a href='../Y/3229.html' title='Multiple used in 4 places.'>libc5</a>, &amp;<a href='../Y/3230.html' title='Multiple used in 4 places.'>libc6</a>, &amp;<a href='../Y/3231.html' title='Multiple used in 4 places.'>libc7</a>, &amp;<a href='../Y/3232.html' title='Multiple used in 4 places.'>libc8</a>
<a id='L393' name='L393' /><em class='brace'>}</em>;
<a id='L394' name='L394' /><strong class='reserved'>static</strong> <a href='../S/684.html#L325' title='Defined at 325 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>WindowsInfo</a> <a href='../Y/3383.html' title='Multiple used in 3 places.'>main_executable_windows</a>;
<a id='L395' name='L395' />
<a id='L396' name='L396' /><strong class='reserved'>const</strong> <strong class='reserved'>char</strong>* <strong class='reserved'>const</strong> <a href='../S/684.html#L147' title='Defined at 147 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfo</a>::<a href='../Y/2494.html' title='Multiple used in 4 places.'>function_name_</a>[] = <em class='brace'>{</em>
<a id='L397' name='L397' />  "malloc", "free", "realloc", "calloc",
<a id='L398' name='L398' />  <a href='../Y/3046.html' title='Multiple used in 2 places.'>kMangledNew</a>, <a href='../Y/3047.html' title='Multiple used in 2 places.'>kMangledNewArray</a>, <a href='../Y/3042.html' title='Multiple used in 2 places.'>kMangledDelete</a>, <a href='../Y/3043.html' title='Multiple used in 2 places.'>kMangledDeleteArray</a>,
<a id='L399' name='L399' />  <em class='comment'>// Ideally we should patch the nothrow versions of new/delete, but</em>
<a id='L400' name='L400' />  <em class='comment'>// at least in msvcrt, nothrow-new machine-code is of a type we</em>
<a id='L401' name='L401' />  <em class='comment'>// can't patch.  Since these are relatively rare, I'm hoping it's ok</em>
<a id='L402' name='L402' />  <em class='comment'>// not to patch them.  (NULL name turns off patching.)</em>
<a id='L403' name='L403' />  <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>,  <em class='comment'>// kMangledNewNothrow,</em>
<a id='L404' name='L404' />  <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>,  <em class='comment'>// kMangledNewArrayNothrow,</em>
<a id='L405' name='L405' />  <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>,  <em class='comment'>// kMangledDeleteNothrow,</em>
<a id='L406' name='L406' />  <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>,  <em class='comment'>// kMangledDeleteArrayNothrow,</em>
<a id='L407' name='L407' />  "_msize", "_expand",
<a id='L408' name='L408' /><em class='brace'>}</em>;
<a id='L409' name='L409' />
<a id='L410' name='L410' /><em class='comment'>// For mingw, I can't patch the new/delete here, because the</em>
<a id='L411' name='L411' /><em class='comment'>// instructions are too small to patch.  Luckily, they're so small</em>
<a id='L412' name='L412' /><em class='comment'>// because all they do is call into malloc/free, so they still end up</em>
<a id='L413' name='L413' /><em class='comment'>// calling tcmalloc routines, and we don't actually lose anything</em>
<a id='L414' name='L414' /><em class='comment'>// (except maybe some stacktrace goodness) by not patching.</em>
<a id='L415' name='L415' /><strong class='reserved'>const</strong> <a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a> <a href='../S/684.html#L147' title='Defined at 147 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfo</a>::<a href='../Y/5083.html' title='Multiple used in 3 places.'>static_fn_</a>[] = <em class='brace'>{</em>
<a id='L416' name='L416' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;::<a href='../D/4497.html' title='Multiple defined in 2 places.'>malloc</a>,
<a id='L417' name='L417' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;::<a href='../D/3828.html' title='Multiple defined in 2 places.'>free</a>,
<a id='L418' name='L418' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;::<a href='../S/578.html#L71' title='Defined at 71 in third_party/google-perftools-1.8.3/src/libc_override_redefine.h.'>realloc</a>,
<a id='L419' name='L419' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;::<a href='../D/3464.html' title='Multiple defined in 2 places.'>calloc</a>,
<a id='L420' name='L420' /><em class='sharp'>#ifdef</em> <a href='../Y/1053.html' title='Multiple used in 17 places.'>__MINGW32__</a>
<a id='L421' name='L421' />  <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>, <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>, <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>, <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>, <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>, <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>, <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>, <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>,
<a id='L422' name='L422' /><em class='sharp'>#else</em>
<a id='L423' name='L423' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)(<strong class='reserved'>void</strong>*(*)(<a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a>))&amp;::<strong class='reserved'>operator</strong> <strong class='reserved'>new</strong>,
<a id='L424' name='L424' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)(<strong class='reserved'>void</strong>*(*)(<a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a>))&amp;::<strong class='reserved'>operator</strong> <strong class='reserved'>new</strong>[],
<a id='L425' name='L425' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)(<strong class='reserved'>void</strong>(*)(<strong class='reserved'>void</strong>*))&amp;::<strong class='reserved'>operator</strong> <strong class='reserved'>delete</strong>,
<a id='L426' name='L426' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)(<strong class='reserved'>void</strong>(*)(<strong class='reserved'>void</strong>*))&amp;::<strong class='reserved'>operator</strong> <strong class='reserved'>delete</strong>[],
<a id='L427' name='L427' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)
<a id='L428' name='L428' />  (<strong class='reserved'>void</strong>*(*)(<a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a>, <strong class='reserved'>struct</strong> <a href='../Y/5100.html' title='Multiple used in 181 places.'>std</a>::<a href='../Y/3844.html' title='Multiple used in 48 places.'>nothrow_t</a> <strong class='reserved'>const</strong> &amp;))&amp;::<strong class='reserved'>operator</strong> <strong class='reserved'>new</strong>,
<a id='L429' name='L429' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)
<a id='L430' name='L430' />  (<strong class='reserved'>void</strong>*(*)(<a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a>, <strong class='reserved'>struct</strong> <a href='../Y/5100.html' title='Multiple used in 181 places.'>std</a>::<a href='../Y/3844.html' title='Multiple used in 48 places.'>nothrow_t</a> <strong class='reserved'>const</strong> &amp;))&amp;::<strong class='reserved'>operator</strong> <strong class='reserved'>new</strong>[],
<a id='L431' name='L431' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)
<a id='L432' name='L432' />  (<strong class='reserved'>void</strong>(*)(<strong class='reserved'>void</strong>*, <strong class='reserved'>struct</strong> <a href='../Y/5100.html' title='Multiple used in 181 places.'>std</a>::<a href='../Y/3844.html' title='Multiple used in 48 places.'>nothrow_t</a> <strong class='reserved'>const</strong> &amp;))&amp;::<strong class='reserved'>operator</strong> <strong class='reserved'>delete</strong>,
<a id='L433' name='L433' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)
<a id='L434' name='L434' />  (<strong class='reserved'>void</strong>(*)(<strong class='reserved'>void</strong>*, <strong class='reserved'>struct</strong> <a href='../Y/5100.html' title='Multiple used in 181 places.'>std</a>::<a href='../Y/3844.html' title='Multiple used in 48 places.'>nothrow_t</a> <strong class='reserved'>const</strong> &amp;))&amp;::<strong class='reserved'>operator</strong> <strong class='reserved'>delete</strong>[],
<a id='L435' name='L435' /><em class='sharp'>#endif</em>
<a id='L436' name='L436' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;::<a href='../S/683.html#L64' title='Defined at 64 in third_party/google-perftools-1.8.3/src/windows/override_functions.cc.'>_msize</a>,
<a id='L437' name='L437' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;::_expand,
<a id='L438' name='L438' /><em class='brace'>}</em>;
<a id='L439' name='L439' />
<a id='L440' name='L440' /><strong class='reserved'>template</strong>&lt;<strong class='reserved'>int</strong> <a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt; <a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a> <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;<a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;::<a href='../Y/4041.html' title='Multiple used in 15 places.'>origstub_fn_</a>[] = <em class='brace'>{</em>
<a id='L441' name='L441' />  <em class='comment'>// This will get filled in at run-time, as patching is done.</em>
<a id='L442' name='L442' /><em class='brace'>}</em>;
<a id='L443' name='L443' />
<a id='L444' name='L444' /><strong class='reserved'>template</strong>&lt;<strong class='reserved'>int</strong> <a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;
<a id='L445' name='L445' /><strong class='reserved'>const</strong> <a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a> <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;<a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;::<a href='../Y/4147.html' title='Multiple used in 5 places.'>perftools_fn_</a>[] = <em class='brace'>{</em>
<a id='L446' name='L446' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;<a href='../S/684.html#L792' title='Defined at 792 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_malloc</a>,
<a id='L447' name='L447' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;<a href='../S/684.html#L799' title='Defined at 799 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_free</a>,
<a id='L448' name='L448' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;<a href='../S/684.html#L809' title='Defined at 809 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_realloc</a>,
<a id='L449' name='L449' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;<a href='../S/684.html#L829' title='Defined at 829 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_calloc</a>,
<a id='L450' name='L450' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;<a href='../S/684.html#L837' title='Defined at 837 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_new</a>,
<a id='L451' name='L451' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;<a href='../S/684.html#L844' title='Defined at 844 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_newarray</a>,
<a id='L452' name='L452' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;<a href='../S/684.html#L851' title='Defined at 851 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_delete</a>,
<a id='L453' name='L453' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;<a href='../S/684.html#L857' title='Defined at 857 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_deletearray</a>,
<a id='L454' name='L454' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;<a href='../S/684.html#L863' title='Defined at 863 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_new_nothrow</a>,
<a id='L455' name='L455' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;<a href='../S/684.html#L871' title='Defined at 871 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_newarray_nothrow</a>,
<a id='L456' name='L456' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;<a href='../S/684.html#L879' title='Defined at 879 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_delete_nothrow</a>,
<a id='L457' name='L457' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;<a href='../S/684.html#L886' title='Defined at 886 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_deletearray_nothrow</a>,
<a id='L458' name='L458' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;<a href='../S/684.html#L902' title='Defined at 902 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools__msize</a>,
<a id='L459' name='L459' />  (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;<a href='../S/684.html#L910' title='Defined at 910 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools__expand</a>,
<a id='L460' name='L460' /><em class='brace'>}</em>;
<a id='L461' name='L461' />
<a id='L462' name='L462' /><em class='comment'>/*static*/</em> <a href='../S/684.html#L325' title='Defined at 325 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>WindowsInfo</a>::<a href='../S/684.html#L339' title='Defined at 339 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>FunctionInfo</a> <a href='../S/684.html#L325' title='Defined at 325 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>WindowsInfo</a>::<a href='../Y/2493.html' title='Multiple used in 20 places.'>function_info_</a>[] = <em class='brace'>{</em>
<a id='L463' name='L463' />  <em class='brace'>{</em> "HeapAlloc", <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>, <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>, (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;<a href='../S/684.html#L915' title='Defined at 915 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_HeapAlloc</a> <em class='brace'>}</em>,
<a id='L464' name='L464' />  <em class='brace'>{</em> "HeapFree", <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>, <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>, (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;<a href='../S/684.html#L924' title='Defined at 924 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_HeapFree</a> <em class='brace'>}</em>,
<a id='L465' name='L465' />  <em class='brace'>{</em> "VirtualAllocEx", <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>, <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>, (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;<a href='../S/684.html#L932' title='Defined at 932 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_VirtualAllocEx</a> <em class='brace'>}</em>,
<a id='L466' name='L466' />  <em class='brace'>{</em> "VirtualFreeEx", <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>, <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>, (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;<a href='../S/684.html#L944' title='Defined at 944 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_VirtualFreeEx</a> <em class='brace'>}</em>,
<a id='L467' name='L467' />  <em class='brace'>{</em> "MapViewOfFileEx", <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>, <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>, (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;<a href='../S/684.html#L952' title='Defined at 952 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_MapViewOfFileEx</a> <em class='brace'>}</em>,
<a id='L468' name='L468' />  <em class='brace'>{</em> "UnmapViewOfFile", <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>, <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>, (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;<a href='../S/684.html#L966' title='Defined at 966 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_UnmapViewOfFile</a> <em class='brace'>}</em>,
<a id='L469' name='L469' />  <em class='brace'>{</em> "LoadLibraryExW", <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>, <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>, (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;<a href='../S/684.html#L983' title='Defined at 983 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_LoadLibraryExW</a> <em class='brace'>}</em>,
<a id='L470' name='L470' />  <em class='brace'>{</em> "FreeLibrary", <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>, <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>, (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)&amp;<a href='../S/684.html#L1006' title='Defined at 1006 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>Perftools_FreeLibrary</a> <em class='brace'>}</em>,
<a id='L471' name='L471' /><em class='brace'>}</em>;
<a id='L472' name='L472' />
<a id='L473' name='L473' /><strong class='reserved'>bool</strong> <a href='../S/684.html#L147' title='Defined at 147 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfo</a>::<a href='../Y/646.html' title='Multiple used in 4 places.'>PopulateWindowsFn</a>(<strong class='reserved'>const</strong> <a href='../S/684.html#L291' title='Defined at 291 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>ModuleEntryCopy</a>&amp; <a href='../Y/3588.html' title='Multiple used in 5 places.'>module_entry</a>) <em class='brace'>{</em>
<a id='L474' name='L474' />  <em class='comment'>// First, store the location of the function to patch before</em>
<a id='L475' name='L475' />  <em class='comment'>// patching it.  If none of these functions are found in the module,</em>
<a id='L476' name='L476' />  <em class='comment'>// then this module has no libc in it, and we just return false.</em>
<a id='L477' name='L477' />  <strong class='reserved'>for</strong> (<strong class='reserved'>int</strong> <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> = 0; <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> &lt; <a href='../D/4122.html' title='Multiple defined in 2 places.'>kNumFunctions</a>; <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>++) <em class='brace'>{</em>
<a id='L478' name='L478' />    <strong class='reserved'>if</strong> (!<a href='../Y/2494.html' title='Multiple used in 4 places.'>function_name_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>])     <em class='comment'>// we can turn off patching by unsetting name</em>
<a id='L479' name='L479' />      <strong class='reserved'>continue</strong>;
<a id='L480' name='L480' />    <em class='comment'>// The ::GetProcAddress calls were done in the ModuleEntryCopy</em>
<a id='L481' name='L481' />    <em class='comment'>// constructor, so we don't have to make any windows calls here.</em>
<a id='L482' name='L482' />    <strong class='reserved'>const</strong> <a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a> <a href='../Y/2409.html' title='Multiple used in 54 places.'>fn</a> = <a href='../Y/3588.html' title='Multiple used in 5 places.'>module_entry</a>.<a href='../Y/4559.html' title='Multiple used in 7 places.'>rgProcAddresses</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>];
<a id='L483' name='L483' />    <strong class='reserved'>if</strong> (<a href='../Y/2409.html' title='Multiple used in 54 places.'>fn</a>) <em class='brace'>{</em>
<a id='L484' name='L484' />      <a href='../Y/5688.html' title='Multiple used in 14 places.'>windows_fn_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>] = <a href='../Y/649.html' title='Multiple used in 12 places.'>PreamblePatcher</a>::<a href='../Y/705.html' title='Multiple used in 3 places.'>ResolveTarget</a>(<a href='../Y/2409.html' title='Multiple used in 54 places.'>fn</a>);
<a id='L485' name='L485' />    <em class='brace'>}</em>
<a id='L486' name='L486' />  <em class='brace'>}</em>
<a id='L487' name='L487' />
<a id='L488' name='L488' />  <em class='comment'>// Some modules use the same function pointer for new and new[].  If</em>
<a id='L489' name='L489' />  <em class='comment'>// we find that, set one of the pointers to NULL so we don't double-</em>
<a id='L490' name='L490' />  <em class='comment'>// patch.  Same may happen with new and nothrow-new, or even new[]</em>
<a id='L491' name='L491' />  <em class='comment'>// and nothrow-new.  It's easiest just to check each fn-ptr against</em>
<a id='L492' name='L492' />  <em class='comment'>// every other.</em>
<a id='L493' name='L493' />  <strong class='reserved'>for</strong> (<strong class='reserved'>int</strong> <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> = 0; <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> &lt; <a href='../D/4122.html' title='Multiple defined in 2 places.'>kNumFunctions</a>; <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>++) <em class='brace'>{</em>
<a id='L494' name='L494' />    <strong class='reserved'>for</strong> (<strong class='reserved'>int</strong> <a href='../Y/2947.html' title='Multiple used in 260 places.'>j</a> = <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>+1; <a href='../Y/2947.html' title='Multiple used in 260 places.'>j</a> &lt; <a href='../D/4122.html' title='Multiple defined in 2 places.'>kNumFunctions</a>; <a href='../Y/2947.html' title='Multiple used in 260 places.'>j</a>++) <em class='brace'>{</em>
<a id='L495' name='L495' />      <strong class='reserved'>if</strong> (<a href='../Y/5688.html' title='Multiple used in 14 places.'>windows_fn_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>] == <a href='../Y/5688.html' title='Multiple used in 14 places.'>windows_fn_</a>[<a href='../Y/2947.html' title='Multiple used in 260 places.'>j</a>]) <em class='brace'>{</em>
<a id='L496' name='L496' />        <em class='comment'>// We NULL the later one (j), so as to minimize the chances we</em>
<a id='L497' name='L497' />        <em class='comment'>// NULL kFree and kRealloc.  See comments below.  This is fragile!</em>
<a id='L498' name='L498' />        <a href='../Y/5688.html' title='Multiple used in 14 places.'>windows_fn_</a>[<a href='../Y/2947.html' title='Multiple used in 260 places.'>j</a>] = <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>;
<a id='L499' name='L499' />      <em class='brace'>}</em>
<a id='L500' name='L500' />    <em class='brace'>}</em>
<a id='L501' name='L501' />  <em class='brace'>}</em>
<a id='L502' name='L502' />
<a id='L503' name='L503' />  <em class='comment'>// There's always a chance that our module uses the same function</em>
<a id='L504' name='L504' />  <em class='comment'>// as another module that we've already loaded.  In that case, we</em>
<a id='L505' name='L505' />  <em class='comment'>// need to set our windows_fn to NULL, to avoid double-patching.</em>
<a id='L506' name='L506' />  <strong class='reserved'>for</strong> (<strong class='reserved'>int</strong> <a href='../Y/2762.html' title='Multiple used in 3 places.'>ifn</a> = 0; <a href='../Y/2762.html' title='Multiple used in 3 places.'>ifn</a> &lt; <a href='../D/4122.html' title='Multiple defined in 2 places.'>kNumFunctions</a>; <a href='../Y/2762.html' title='Multiple used in 3 places.'>ifn</a>++) <em class='brace'>{</em>
<a id='L507' name='L507' />    <strong class='reserved'>for</strong> (<strong class='reserved'>int</strong> <a href='../Y/2781.html' title='Multiple used in 4 places.'>imod</a> = 0;
<a id='L508' name='L508' />         <a href='../Y/2781.html' title='Multiple used in 4 places.'>imod</a> &lt; <strong class='reserved'>sizeof</strong>(<a href='../Y/2516.html' title='Multiple used in 10 places.'>g_module_libcs</a>)/<strong class='reserved'>sizeof</strong>(*<a href='../Y/2516.html' title='Multiple used in 10 places.'>g_module_libcs</a>);  <a href='../Y/2781.html' title='Multiple used in 4 places.'>imod</a>++) <em class='brace'>{</em>
<a id='L509' name='L509' />      <strong class='reserved'>if</strong> (<a href='../Y/2516.html' title='Multiple used in 10 places.'>g_module_libcs</a>[<a href='../Y/2781.html' title='Multiple used in 4 places.'>imod</a>]-&gt;<a href='../S/684.html#L221' title='Defined at 221 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>is_valid</a>() &amp;&amp;
<a id='L510' name='L510' />          <strong class='reserved'>this</strong>-&gt;<a href='../S/684.html#L222' title='Defined at 222 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>windows_fn</a>(<a href='../Y/2762.html' title='Multiple used in 3 places.'>ifn</a>) == <a href='../Y/2516.html' title='Multiple used in 10 places.'>g_module_libcs</a>[<a href='../Y/2781.html' title='Multiple used in 4 places.'>imod</a>]-&gt;<a href='../S/684.html#L222' title='Defined at 222 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>windows_fn</a>(<a href='../Y/2762.html' title='Multiple used in 3 places.'>ifn</a>)) <em class='brace'>{</em>
<a id='L511' name='L511' />        <a href='../Y/5688.html' title='Multiple used in 14 places.'>windows_fn_</a>[<a href='../Y/2762.html' title='Multiple used in 3 places.'>ifn</a>] = <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>;
<a id='L512' name='L512' />      <em class='brace'>}</em>
<a id='L513' name='L513' />    <em class='brace'>}</em>
<a id='L514' name='L514' />  <em class='brace'>}</em>
<a id='L515' name='L515' />
<a id='L516' name='L516' />  <strong class='reserved'>bool</strong> <a href='../Y/2432.html' title='Multiple used in 3 places.'>found_non_null</a> = <strong class='reserved'>false</strong>;
<a id='L517' name='L517' />  <strong class='reserved'>for</strong> (<strong class='reserved'>int</strong> <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> = 0; <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> &lt; <a href='../D/4122.html' title='Multiple defined in 2 places.'>kNumFunctions</a>; <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>++) <em class='brace'>{</em>
<a id='L518' name='L518' />    <strong class='reserved'>if</strong> (<a href='../Y/5688.html' title='Multiple used in 14 places.'>windows_fn_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>])
<a id='L519' name='L519' />      <a href='../Y/2432.html' title='Multiple used in 3 places.'>found_non_null</a> = <strong class='reserved'>true</strong>;
<a id='L520' name='L520' />  <em class='brace'>}</em>
<a id='L521' name='L521' />  <strong class='reserved'>if</strong> (!<a href='../Y/2432.html' title='Multiple used in 3 places.'>found_non_null</a>)
<a id='L522' name='L522' />    <strong class='reserved'>return</strong> <strong class='reserved'>false</strong>;
<a id='L523' name='L523' />
<a id='L524' name='L524' />  <em class='comment'>// It's important we didn't NULL out windows_fn_[kFree] or [kRealloc].</em>
<a id='L525' name='L525' />  <em class='comment'>// The reason is, if those are NULL-ed out, we'll never patch them</em>
<a id='L526' name='L526' />  <em class='comment'>// and thus never get an origstub_fn_ value for them, and when we</em>
<a id='L527' name='L527' />  <em class='comment'>// try to call origstub_fn_[kFree/kRealloc] in Perftools_free and</em>
<a id='L528' name='L528' />  <em class='comment'>// Perftools_realloc, below, it will fail.  We could work around</em>
<a id='L529' name='L529' />  <em class='comment'>// that by adding a pointer from one patch-unit to the other, but we</em>
<a id='L530' name='L530' />  <em class='comment'>// haven't needed to yet.</em>
<a id='L531' name='L531' />  <a href='../S/529.html#L83' title='Defined at 83 in third_party/google-perftools-1.8.3/src/base/logging.h.'>CHECK</a>(<a href='../Y/5688.html' title='Multiple used in 14 places.'>windows_fn_</a>[<a href='../S/684.html#L179' title='Defined at 179 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kFree</a>]);
<a id='L532' name='L532' />  <a href='../S/529.html#L83' title='Defined at 83 in third_party/google-perftools-1.8.3/src/base/logging.h.'>CHECK</a>(<a href='../Y/5688.html' title='Multiple used in 14 places.'>windows_fn_</a>[<a href='../S/684.html#L179' title='Defined at 179 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kRealloc</a>]);
<a id='L533' name='L533' />
<a id='L534' name='L534' />  <em class='comment'>// OK, we successfully populated.  Let's store our member information.</em>
<a id='L535' name='L535' />  <a href='../Y/3584.html' title='Multiple used in 4 places.'>module_base_address_</a> = <a href='../Y/3588.html' title='Multiple used in 5 places.'>module_entry</a>.<a href='../Y/3571.html' title='Multiple used in 6 places.'>modBaseAddr</a>;
<a id='L536' name='L536' />  <a href='../Y/3585.html' title='Multiple used in 3 places.'>module_base_size_</a> = <a href='../Y/3588.html' title='Multiple used in 5 places.'>module_entry</a>.<a href='../Y/3572.html' title='Multiple used in 5 places.'>modBaseSize</a>;
<a id='L537' name='L537' />  <strong class='reserved'>return</strong> <strong class='reserved'>true</strong>;
<a id='L538' name='L538' /><em class='brace'>}</em>
<a id='L539' name='L539' />
<a id='L540' name='L540' /><strong class='reserved'>template</strong>&lt;<strong class='reserved'>int</strong> <a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;
<a id='L541' name='L541' /><strong class='reserved'>bool</strong> <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;<a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;::<a href='../Y/636.html' title='Multiple used in 18 places.'>Patch</a>(<strong class='reserved'>const</strong> <a href='../S/684.html#L147' title='Defined at 147 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfo</a>&amp; <a href='../Y/3485.html' title='Multiple used in 12 places.'>me_info</a>) <em class='brace'>{</em>
<a id='L542' name='L542' />  <a href='../S/684.html#L169' title='Defined at 169 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>CopyFrom</a>(<a href='../Y/3485.html' title='Multiple used in 12 places.'>me_info</a>);   <em class='comment'>// copies the module_entry and the windows_fn_ array</em>
<a id='L543' name='L543' />  <strong class='reserved'>for</strong> (<strong class='reserved'>int</strong> <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> = 0; <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> &lt; <a href='../D/4122.html' title='Multiple defined in 2 places.'>kNumFunctions</a>; <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>++) <em class='brace'>{</em>
<a id='L544' name='L544' />    <strong class='reserved'>if</strong> (<a href='../Y/5688.html' title='Multiple used in 14 places.'>windows_fn_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>] &amp;&amp; <a href='../Y/5688.html' title='Multiple used in 14 places.'>windows_fn_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>] != <a href='../Y/4147.html' title='Multiple used in 5 places.'>perftools_fn_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>]) <em class='brace'>{</em>
<a id='L545' name='L545' />      <em class='comment'>// if origstub_fn_ is not NULL, it's left around from a previous</em>
<a id='L546' name='L546' />      <em class='comment'>// patch.  We need to set it to NULL for the new Patch call.</em>
<a id='L547' name='L547' />      <em class='comment'>// Since we've patched Unpatch() not to delete origstub_fn_ (it</em>
<a id='L548' name='L548' />      <em class='comment'>// causes problems in some contexts, though obviously not this</em>
<a id='L549' name='L549' />      <em class='comment'>// one), we should delete it now, before setting it to NULL.</em>
<a id='L550' name='L550' />      <em class='comment'>// NOTE: casting from a function to a pointer is contra the C++</em>
<a id='L551' name='L551' />      <em class='comment'>//       spec.  It's not safe on IA64, but is on i386.  We use</em>
<a id='L552' name='L552' />      <em class='comment'>//       a C-style cast here to emphasize this is not legal C++.</em>
<a id='L553' name='L553' />      <strong class='reserved'>delete</strong>[] (<strong class='reserved'>char</strong>*)(<a href='../Y/4041.html' title='Multiple used in 15 places.'>origstub_fn_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>]);
<a id='L554' name='L554' />      <a href='../Y/4041.html' title='Multiple used in 15 places.'>origstub_fn_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>] = <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>;   <em class='comment'>// Patch() will fill this in</em>
<a id='L555' name='L555' />      <a href='../S/529.html#L142' title='Defined at 142 in third_party/google-perftools-1.8.3/src/base/logging.h.'>CHECK_EQ</a>(<a href='../D/5094.html' title='Multiple defined in 5 places.'>sidestep</a>::<a href='../S/688.html#L56' title='Defined at 56 in third_party/google-perftools-1.8.3/src/windows/preamble_patcher.h.'>SIDESTEP_SUCCESS</a>,
<a id='L556' name='L556' />               <a href='../Y/649.html' title='Multiple used in 12 places.'>PreamblePatcher</a>::<a href='../Y/636.html' title='Multiple used in 18 places.'>Patch</a>(<a href='../Y/5688.html' title='Multiple used in 14 places.'>windows_fn_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>], <a href='../Y/4147.html' title='Multiple used in 5 places.'>perftools_fn_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>],
<a id='L557' name='L557' />                                      &amp;<a href='../Y/4041.html' title='Multiple used in 15 places.'>origstub_fn_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>]));
<a id='L558' name='L558' />    <em class='brace'>}</em>
<a id='L559' name='L559' />  <em class='brace'>}</em>
<a id='L560' name='L560' />  <a href='../S/684.html#L154' title='Defined at 154 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>set_is_valid</a>(<strong class='reserved'>true</strong>);
<a id='L561' name='L561' />  <strong class='reserved'>return</strong> <strong class='reserved'>true</strong>;
<a id='L562' name='L562' /><em class='brace'>}</em>
<a id='L563' name='L563' />
<a id='L564' name='L564' /><strong class='reserved'>template</strong>&lt;<strong class='reserved'>int</strong> <a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;
<a id='L565' name='L565' /><strong class='reserved'>void</strong> <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;<a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;::<a href='../S/687.html#L253' title='Defined at 253 in third_party/google-perftools-1.8.3/src/windows/preamble_patcher.cc.'>Unpatch</a>() <em class='brace'>{</em>
<a id='L566' name='L566' />  <em class='comment'>// We have to cast our GenericFnPtrs to void* for unpatch.  This is</em>
<a id='L567' name='L567' />  <em class='comment'>// contra the C++ spec; we use C-style casts to empahsize that.</em>
<a id='L568' name='L568' />  <strong class='reserved'>for</strong> (<strong class='reserved'>int</strong> <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> = 0; <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> &lt; <a href='../D/4122.html' title='Multiple defined in 2 places.'>kNumFunctions</a>; <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>++) <em class='brace'>{</em>
<a id='L569' name='L569' />    <strong class='reserved'>if</strong> (<a href='../Y/5688.html' title='Multiple used in 14 places.'>windows_fn_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>])
<a id='L570' name='L570' />      <a href='../S/529.html#L142' title='Defined at 142 in third_party/google-perftools-1.8.3/src/base/logging.h.'>CHECK_EQ</a>(<a href='../D/5094.html' title='Multiple defined in 5 places.'>sidestep</a>::<a href='../S/688.html#L56' title='Defined at 56 in third_party/google-perftools-1.8.3/src/windows/preamble_patcher.h.'>SIDESTEP_SUCCESS</a>,
<a id='L571' name='L571' />               <a href='../Y/649.html' title='Multiple used in 12 places.'>PreamblePatcher</a>::<a href='../S/687.html#L253' title='Defined at 253 in third_party/google-perftools-1.8.3/src/windows/preamble_patcher.cc.'>Unpatch</a>((<strong class='reserved'>void</strong>*)<a href='../Y/5688.html' title='Multiple used in 14 places.'>windows_fn_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>],
<a id='L572' name='L572' />                                        (<strong class='reserved'>void</strong>*)<a href='../Y/4147.html' title='Multiple used in 5 places.'>perftools_fn_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>],
<a id='L573' name='L573' />                                        (<strong class='reserved'>void</strong>*)<a href='../Y/4041.html' title='Multiple used in 15 places.'>origstub_fn_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>]));
<a id='L574' name='L574' />  <em class='brace'>}</em>
<a id='L575' name='L575' />  <a href='../S/684.html#L154' title='Defined at 154 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>set_is_valid</a>(<strong class='reserved'>false</strong>);
<a id='L576' name='L576' /><em class='brace'>}</em>
<a id='L577' name='L577' />
<a id='L578' name='L578' /><strong class='reserved'>void</strong> <a href='../S/684.html#L325' title='Defined at 325 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>WindowsInfo</a>::<a href='../Y/636.html' title='Multiple used in 18 places.'>Patch</a>() <em class='brace'>{</em>
<a id='L579' name='L579' />  <a href='../Y/351.html' title='Multiple used in 18 places.'>HMODULE</a> <a href='../Y/2708.html' title='Multiple used in 3 places.'>hkernel32</a> = ::<a href='../Y/308.html' title='Multiple used in 2 places.'>GetModuleHandleA</a>("kernel32");
<a id='L580' name='L580' />  <a href='../S/529.html#L143' title='Defined at 143 in third_party/google-perftools-1.8.3/src/base/logging.h.'>CHECK_NE</a>(<a href='../Y/2708.html' title='Multiple used in 3 places.'>hkernel32</a>, <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>);
<a id='L581' name='L581' />
<a id='L582' name='L582' />  <em class='comment'>// Unlike for libc, we know these exist in our module, so we can get</em>
<a id='L583' name='L583' />  <em class='comment'>// and patch at the same time.</em>
<a id='L584' name='L584' />  <strong class='reserved'>for</strong> (<strong class='reserved'>int</strong> <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> = 0; <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> &lt; <a href='../D/4122.html' title='Multiple defined in 2 places.'>kNumFunctions</a>; <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>++) <em class='brace'>{</em>
<a id='L585' name='L585' />    <a href='../Y/2493.html' title='Multiple used in 20 places.'>function_info_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>].<a href='../S/684.html#L222' title='Defined at 222 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>windows_fn</a> = (<a href='../Y/293.html' title='Multiple used in 54 places.'>GenericFnPtr</a>)
<a id='L586' name='L586' />        ::<a href='../Y/313.html' title='Multiple used in 4 places.'>GetProcAddress</a>(<a href='../Y/2708.html' title='Multiple used in 3 places.'>hkernel32</a>, <a href='../Y/2493.html' title='Multiple used in 20 places.'>function_info_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>].<a href='../Y/3665.html' title='Multiple used in 438 places.'>name</a>);
<a id='L587' name='L587' />    <em class='comment'>// If origstub_fn is not NULL, it's left around from a previous</em>
<a id='L588' name='L588' />    <em class='comment'>// patch.  We need to set it to NULL for the new Patch call.</em>
<a id='L589' name='L589' />    <em class='comment'>// Since we've patched Unpatch() not to delete origstub_fn_ (it</em>
<a id='L590' name='L590' />    <em class='comment'>// causes problems in some contexts, though obviously not this</em>
<a id='L591' name='L591' />    <em class='comment'>// one), we should delete it now, before setting it to NULL.</em>
<a id='L592' name='L592' />    <em class='comment'>// NOTE: casting from a function to a pointer is contra the C++</em>
<a id='L593' name='L593' />    <em class='comment'>//       spec.  It's not safe on IA64, but is on i386.  We use</em>
<a id='L594' name='L594' />    <em class='comment'>//       a C-style cast here to emphasize this is not legal C++.</em>
<a id='L595' name='L595' />    <strong class='reserved'>delete</strong>[] (<strong class='reserved'>char</strong>*)(<a href='../Y/2493.html' title='Multiple used in 20 places.'>function_info_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>].<a href='../Y/4040.html' title='Multiple used in 13 places.'>origstub_fn</a>);
<a id='L596' name='L596' />    <a href='../Y/2493.html' title='Multiple used in 20 places.'>function_info_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>].<a href='../Y/4040.html' title='Multiple used in 13 places.'>origstub_fn</a> = <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>;  <em class='comment'>// Patch() will fill this in</em>
<a id='L597' name='L597' />    <a href='../S/529.html#L142' title='Defined at 142 in third_party/google-perftools-1.8.3/src/base/logging.h.'>CHECK_EQ</a>(<a href='../D/5094.html' title='Multiple defined in 5 places.'>sidestep</a>::<a href='../S/688.html#L56' title='Defined at 56 in third_party/google-perftools-1.8.3/src/windows/preamble_patcher.h.'>SIDESTEP_SUCCESS</a>,
<a id='L598' name='L598' />             <a href='../Y/649.html' title='Multiple used in 12 places.'>PreamblePatcher</a>::<a href='../Y/636.html' title='Multiple used in 18 places.'>Patch</a>(<a href='../Y/2493.html' title='Multiple used in 20 places.'>function_info_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>].<a href='../S/684.html#L222' title='Defined at 222 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>windows_fn</a>,
<a id='L599' name='L599' />                                    <a href='../Y/2493.html' title='Multiple used in 20 places.'>function_info_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>].<a href='../Y/4146.html' title='Multiple used in 3 places.'>perftools_fn</a>,
<a id='L600' name='L600' />                                    &amp;<a href='../Y/2493.html' title='Multiple used in 20 places.'>function_info_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>].<a href='../Y/4040.html' title='Multiple used in 13 places.'>origstub_fn</a>));
<a id='L601' name='L601' />  <em class='brace'>}</em>
<a id='L602' name='L602' /><em class='brace'>}</em>
<a id='L603' name='L603' />
<a id='L604' name='L604' /><strong class='reserved'>void</strong> <a href='../S/684.html#L325' title='Defined at 325 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>WindowsInfo</a>::<a href='../S/687.html#L253' title='Defined at 253 in third_party/google-perftools-1.8.3/src/windows/preamble_patcher.cc.'>Unpatch</a>() <em class='brace'>{</em>
<a id='L605' name='L605' />  <em class='comment'>// We have to cast our GenericFnPtrs to void* for unpatch.  This is</em>
<a id='L606' name='L606' />  <em class='comment'>// contra the C++ spec; we use C-style casts to empahsize that.</em>
<a id='L607' name='L607' />  <strong class='reserved'>for</strong> (<strong class='reserved'>int</strong> <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> = 0; <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> &lt; <a href='../D/4122.html' title='Multiple defined in 2 places.'>kNumFunctions</a>; <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>++) <em class='brace'>{</em>
<a id='L608' name='L608' />    <a href='../S/529.html#L142' title='Defined at 142 in third_party/google-perftools-1.8.3/src/base/logging.h.'>CHECK_EQ</a>(<a href='../D/5094.html' title='Multiple defined in 5 places.'>sidestep</a>::<a href='../S/688.html#L56' title='Defined at 56 in third_party/google-perftools-1.8.3/src/windows/preamble_patcher.h.'>SIDESTEP_SUCCESS</a>,
<a id='L609' name='L609' />             <a href='../Y/649.html' title='Multiple used in 12 places.'>PreamblePatcher</a>::<a href='../S/687.html#L253' title='Defined at 253 in third_party/google-perftools-1.8.3/src/windows/preamble_patcher.cc.'>Unpatch</a>((<strong class='reserved'>void</strong>*)<a href='../Y/2493.html' title='Multiple used in 20 places.'>function_info_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>].<a href='../S/684.html#L222' title='Defined at 222 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>windows_fn</a>,
<a id='L610' name='L610' />                                      (<strong class='reserved'>void</strong>*)<a href='../Y/2493.html' title='Multiple used in 20 places.'>function_info_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>].<a href='../Y/4146.html' title='Multiple used in 3 places.'>perftools_fn</a>,
<a id='L611' name='L611' />                                      (<strong class='reserved'>void</strong>*)<a href='../Y/2493.html' title='Multiple used in 20 places.'>function_info_</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>].<a href='../Y/4040.html' title='Multiple used in 13 places.'>origstub_fn</a>));
<a id='L612' name='L612' />  <em class='brace'>}</em>
<a id='L613' name='L613' /><em class='brace'>}</em>
<a id='L614' name='L614' />
<a id='L615' name='L615' /><em class='comment'>// You should hold the patch_all_modules_lock when calling this.</em>
<a id='L616' name='L616' /><strong class='reserved'>void</strong> <a href='../Y/639.html' title='Multiple used in 2 places.'>PatchOneModuleLocked</a>(<strong class='reserved'>const</strong> <a href='../S/684.html#L147' title='Defined at 147 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfo</a>&amp; <a href='../Y/3485.html' title='Multiple used in 12 places.'>me_info</a>) <em class='brace'>{</em>
<a id='L617' name='L617' />  <em class='comment'>// If we don't already have info on this module, let's add it.  This</em>
<a id='L618' name='L618' />  <em class='comment'>// is where we're sad that each libcX has a different type, so we</em>
<a id='L619' name='L619' />  <em class='comment'>// can't use an array; instead, we have to use a switch statement.</em>
<a id='L620' name='L620' />  <em class='comment'>// Patch() returns false if there were no libc functions in the module.</em>
<a id='L621' name='L621' />  <strong class='reserved'>for</strong> (<strong class='reserved'>int</strong> <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> = 0; <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> &lt; <strong class='reserved'>sizeof</strong>(<a href='../Y/2516.html' title='Multiple used in 10 places.'>g_module_libcs</a>)/<strong class='reserved'>sizeof</strong>(*<a href='../Y/2516.html' title='Multiple used in 10 places.'>g_module_libcs</a>); <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>++) <em class='brace'>{</em>
<a id='L622' name='L622' />    <strong class='reserved'>if</strong> (!<a href='../Y/2516.html' title='Multiple used in 10 places.'>g_module_libcs</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>]-&gt;<a href='../S/684.html#L221' title='Defined at 221 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>is_valid</a>()) <em class='brace'>{</em>   <em class='comment'>// found an empty spot to add!</em>
<a id='L623' name='L623' />      <strong class='reserved'>switch</strong> (<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>) <em class='brace'>{</em>
<a id='L624' name='L624' />        <strong class='reserved'>case</strong> 0: <a href='../Y/3225.html' title='Multiple used in 4 places.'>libc1</a>.<a href='../Y/636.html' title='Multiple used in 18 places.'>Patch</a>(<a href='../Y/3485.html' title='Multiple used in 12 places.'>me_info</a>); <strong class='reserved'>return</strong>;
<a id='L625' name='L625' />        <strong class='reserved'>case</strong> 1: <a href='../Y/3226.html' title='Multiple used in 4 places.'>libc2</a>.<a href='../Y/636.html' title='Multiple used in 18 places.'>Patch</a>(<a href='../Y/3485.html' title='Multiple used in 12 places.'>me_info</a>); <strong class='reserved'>return</strong>;
<a id='L626' name='L626' />        <strong class='reserved'>case</strong> 2: <a href='../Y/3227.html' title='Multiple used in 4 places.'>libc3</a>.<a href='../Y/636.html' title='Multiple used in 18 places.'>Patch</a>(<a href='../Y/3485.html' title='Multiple used in 12 places.'>me_info</a>); <strong class='reserved'>return</strong>;
<a id='L627' name='L627' />        <strong class='reserved'>case</strong> 3: <a href='../Y/3228.html' title='Multiple used in 4 places.'>libc4</a>.<a href='../Y/636.html' title='Multiple used in 18 places.'>Patch</a>(<a href='../Y/3485.html' title='Multiple used in 12 places.'>me_info</a>); <strong class='reserved'>return</strong>;
<a id='L628' name='L628' />        <strong class='reserved'>case</strong> 4: <a href='../Y/3229.html' title='Multiple used in 4 places.'>libc5</a>.<a href='../Y/636.html' title='Multiple used in 18 places.'>Patch</a>(<a href='../Y/3485.html' title='Multiple used in 12 places.'>me_info</a>); <strong class='reserved'>return</strong>;
<a id='L629' name='L629' />        <strong class='reserved'>case</strong> 5: <a href='../Y/3230.html' title='Multiple used in 4 places.'>libc6</a>.<a href='../Y/636.html' title='Multiple used in 18 places.'>Patch</a>(<a href='../Y/3485.html' title='Multiple used in 12 places.'>me_info</a>); <strong class='reserved'>return</strong>;
<a id='L630' name='L630' />        <strong class='reserved'>case</strong> 6: <a href='../Y/3231.html' title='Multiple used in 4 places.'>libc7</a>.<a href='../Y/636.html' title='Multiple used in 18 places.'>Patch</a>(<a href='../Y/3485.html' title='Multiple used in 12 places.'>me_info</a>); <strong class='reserved'>return</strong>;
<a id='L631' name='L631' />        <strong class='reserved'>case</strong> 7: <a href='../Y/3232.html' title='Multiple used in 4 places.'>libc8</a>.<a href='../Y/636.html' title='Multiple used in 18 places.'>Patch</a>(<a href='../Y/3485.html' title='Multiple used in 12 places.'>me_info</a>); <strong class='reserved'>return</strong>;
<a id='L632' name='L632' />      <em class='brace'>}</em>
<a id='L633' name='L633' />    <em class='brace'>}</em>
<a id='L634' name='L634' />  <em class='brace'>}</em>
<a id='L635' name='L635' />  <a href='../S/572.html#L176' title='Defined at 176 in third_party/google-perftools-1.8.3/src/internal_logging.cc.'>printf</a>("PERFTOOLS ERROR: Too many modules containing libc in this executable\n");
<a id='L636' name='L636' /><em class='brace'>}</em>
<a id='L637' name='L637' />
<a id='L638' name='L638' /><strong class='reserved'>void</strong> <a href='../Y/638.html' title='Multiple used in 2 places.'>PatchMainExecutableLocked</a>() <em class='brace'>{</em>
<a id='L639' name='L639' />  <strong class='reserved'>if</strong> (<a href='../Y/3382.html' title='Multiple used in 6 places.'>main_executable</a>.<a href='../S/684.html#L153' title='Defined at 153 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>patched</a>())
<a id='L640' name='L640' />    <strong class='reserved'>return</strong>;    <em class='comment'>// main executable has already been patched</em>
<a id='L641' name='L641' />  <a href='../S/684.html#L291' title='Defined at 291 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>ModuleEntryCopy</a> <a href='../Y/2327.html' title='Multiple used in 2 places.'>fake_module_entry</a>;   <em class='comment'>// make a fake one to pass into Patch()</em>
<a id='L642' name='L642' />  <em class='comment'>// No need to call PopulateModuleEntryProcAddresses on the main executable.</em>
<a id='L643' name='L643' />  <a href='../Y/3382.html' title='Multiple used in 6 places.'>main_executable</a>.<a href='../Y/646.html' title='Multiple used in 4 places.'>PopulateWindowsFn</a>(<a href='../Y/2327.html' title='Multiple used in 2 places.'>fake_module_entry</a>);
<a id='L644' name='L644' />  <a href='../Y/3382.html' title='Multiple used in 6 places.'>main_executable</a>.<a href='../Y/636.html' title='Multiple used in 18 places.'>Patch</a>(<a href='../Y/3382.html' title='Multiple used in 6 places.'>main_executable</a>);
<a id='L645' name='L645' /><em class='brace'>}</em>
<a id='L646' name='L646' />
<a id='L647' name='L647' /><em class='comment'>// This lock is subject to a subtle and annoying lock inversion</em>
<a id='L648' name='L648' /><em class='comment'>// problem: it may interact badly with unknown internal windows locks.</em>
<a id='L649' name='L649' /><em class='comment'>// In particular, windows may be holding a lock when it calls</em>
<a id='L650' name='L650' /><em class='comment'>// LoadLibraryExW and FreeLibrary, which we've patched.  We have those</em>
<a id='L651' name='L651' /><em class='comment'>// routines call PatchAllModules, which acquires this lock.  If we</em>
<a id='L652' name='L652' /><em class='comment'>// make windows system calls while holding this lock, those system</em>
<a id='L653' name='L653' /><em class='comment'>// calls may need the internal windows locks that are being held in</em>
<a id='L654' name='L654' /><em class='comment'>// the call to LoadLibraryExW, resulting in deadlock.  The solution is</em>
<a id='L655' name='L655' /><em class='comment'>// to be very careful not to call *any* windows routines while holding</em>
<a id='L656' name='L656' /><em class='comment'>// patch_all_modules_lock, inside PatchAllModules().</em>
<a id='L657' name='L657' /><strong class='reserved'>static</strong> <a href='../Y/802.html' title='Multiple used in 48 places.'>SpinLock</a> <a href='../Y/4128.html' title='Multiple used in 3 places.'>patch_all_modules_lock</a>(<a href='../Y/802.html' title='Multiple used in 48 places.'>SpinLock</a>::<a href='../D/1389.html' title='Multiple defined in 3 places.'>LINKER_INITIALIZED</a>);
<a id='L658' name='L658' />
<a id='L659' name='L659' /><em class='comment'>// last_loaded: The set of modules that were loaded the last time</em>
<a id='L660' name='L660' /><em class='comment'>// PatchAllModules was called.  This is an optimization for only</em>
<a id='L661' name='L661' /><em class='comment'>// looking at modules that were added or removed from the last call.</em>
<a id='L662' name='L662' /><strong class='reserved'>static</strong> <a href='../Y/5100.html' title='Multiple used in 181 places.'>std</a>::<a href='../Y/4774.html' title='Multiple used in 124 places.'>set</a>&lt;<a href='../Y/351.html' title='Multiple used in 18 places.'>HMODULE</a>&gt; *<a href='../Y/2514.html' title='Multiple used in 4 places.'>g_last_loaded</a>;
<a id='L663' name='L663' />
<a id='L664' name='L664' /><em class='comment'>// Iterates over all the modules currently loaded by the executable,</em>
<a id='L665' name='L665' /><em class='comment'>// according to windows, and makes sure they're all patched.  Most</em>
<a id='L666' name='L666' /><em class='comment'>// modules will already be in loaded_modules, meaning we have already</em>
<a id='L667' name='L667' /><em class='comment'>// loaded and either patched them or determined they did not need to</em>
<a id='L668' name='L668' /><em class='comment'>// be patched.  Others will not, which means we need to patch them</em>
<a id='L669' name='L669' /><em class='comment'>// (if necessary).  Finally, we have to go through the existing</em>
<a id='L670' name='L670' /><em class='comment'>// g_module_libcs and see if any of those are *not* in the modules</em>
<a id='L671' name='L671' /><em class='comment'>// currently loaded by the executable.  If so, we need to invalidate</em>
<a id='L672' name='L672' /><em class='comment'>// them.  Returns true if we did any work (patching or invalidating),</em>
<a id='L673' name='L673' /><em class='comment'>// false if we were a noop.  May update loaded_modules as well.</em>
<a id='L674' name='L674' /><em class='comment'>// NOTE: you must hold the patch_all_modules_lock to access loaded_modules.</em>
<a id='L675' name='L675' /><strong class='reserved'>bool</strong> <a href='../Y/637.html' title='Multiple used in 4 places.'>PatchAllModules</a>() <em class='brace'>{</em>
<a id='L676' name='L676' />  <a href='../Y/5100.html' title='Multiple used in 181 places.'>std</a>::<a href='../Y/5622.html' title='Multiple used in 63 places.'>vector</a>&lt;<a href='../S/684.html#L291' title='Defined at 291 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>ModuleEntryCopy</a>&gt; <a href='../Y/3596.html' title='Multiple used in 12 places.'>modules</a>;
<a id='L677' name='L677' />  <strong class='reserved'>bool</strong> <a href='../Y/3377.html' title='Multiple used in 5 places.'>made_changes</a> = <strong class='reserved'>false</strong>;
<a id='L678' name='L678' />
<a id='L679' name='L679' />  <strong class='reserved'>const</strong> <a href='../Y/331.html' title='Multiple used in 28 places.'>HANDLE</a> <a href='../Y/2605.html' title='Multiple used in 3 places.'>hCurrentProcess</a> = <a href='../Y/298.html' title='Multiple used in 6 places.'>GetCurrentProcess</a>();
<a id='L680' name='L680' />  <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a> <a href='../Y/3874.html' title='Multiple used in 9 places.'>num_modules</a> = 0;
<a id='L681' name='L681' />  <a href='../Y/351.html' title='Multiple used in 18 places.'>HMODULE</a> <a href='../Y/2611.html' title='Multiple used in 7 places.'>hModules</a>[<a href='../Y/3058.html' title='Multiple used in 4 places.'>kMaxModules</a>];  <em class='comment'>// max # of modules we support in one process</em>
<a id='L682' name='L682' />  <strong class='reserved'>if</strong> (!::EnumProcessModules(<a href='../Y/2605.html' title='Multiple used in 3 places.'>hCurrentProcess</a>, <a href='../Y/2611.html' title='Multiple used in 7 places.'>hModules</a>, <strong class='reserved'>sizeof</strong>(<a href='../Y/2611.html' title='Multiple used in 7 places.'>hModules</a>),
<a id='L683' name='L683' />                            &amp;<a href='../Y/3874.html' title='Multiple used in 9 places.'>num_modules</a>)) <em class='brace'>{</em>
<a id='L684' name='L684' />    <a href='../Y/3874.html' title='Multiple used in 9 places.'>num_modules</a> = 0;
<a id='L685' name='L685' />  <em class='brace'>}</em>
<a id='L686' name='L686' />  <em class='comment'>// EnumProcessModules actually set the bytes written into hModules,</em>
<a id='L687' name='L687' />  <em class='comment'>// so we need to divide to make num_modules actually be a module-count.</em>
<a id='L688' name='L688' />  <a href='../Y/3874.html' title='Multiple used in 9 places.'>num_modules</a> /= <strong class='reserved'>sizeof</strong>(*<a href='../Y/2611.html' title='Multiple used in 7 places.'>hModules</a>);
<a id='L689' name='L689' />  <strong class='reserved'>if</strong> (<a href='../Y/3874.html' title='Multiple used in 9 places.'>num_modules</a> &gt;= <a href='../Y/3058.html' title='Multiple used in 4 places.'>kMaxModules</a>) <em class='brace'>{</em>
<a id='L690' name='L690' />    <a href='../S/572.html#L176' title='Defined at 176 in third_party/google-perftools-1.8.3/src/internal_logging.cc.'>printf</a>("PERFTOOLS ERROR: Too many modules in this executable to try"
<a id='L691' name='L691' />           " to patch them all (if you need to, raise kMaxModules in"
<a id='L692' name='L692' />           " patch_functions.cc).\n");
<a id='L693' name='L693' />    <a href='../Y/3874.html' title='Multiple used in 9 places.'>num_modules</a> = <a href='../Y/3058.html' title='Multiple used in 4 places.'>kMaxModules</a>;
<a id='L694' name='L694' />  <em class='brace'>}</em>
<a id='L695' name='L695' />
<a id='L696' name='L696' />  <em class='comment'>// Now we handle the unpatching of modules we have in g_module_libcs</em>
<a id='L697' name='L697' />  <em class='comment'>// but that were not found in EnumProcessModules.  We need to</em>
<a id='L698' name='L698' />  <em class='comment'>// invalidate them.  To speed that up, we store the EnumProcessModules</em>
<a id='L699' name='L699' />  <em class='comment'>// output in a set.</em>
<a id='L700' name='L700' />  <em class='comment'>// At the same time, we prepare for the adding of new modules, by</em>
<a id='L701' name='L701' />  <em class='comment'>// removing from hModules all the modules we know we've already</em>
<a id='L702' name='L702' />  <em class='comment'>// patched (or decided don't need to be patched).  At the end,</em>
<a id='L703' name='L703' />  <em class='comment'>// hModules will hold only the modules that we need to consider patching.</em>
<a id='L704' name='L704' />  <a href='../Y/5100.html' title='Multiple used in 181 places.'>std</a>::<a href='../Y/4774.html' title='Multiple used in 124 places.'>set</a>&lt;<a href='../Y/351.html' title='Multiple used in 18 places.'>HMODULE</a>&gt; <a href='../Y/1938.html' title='Multiple used in 4 places.'>currently_loaded_modules</a>;
<a id='L705' name='L705' />  <em class='brace'>{</em>
<a id='L706' name='L706' />    <a href='../S/534.html#L148' title='Defined at 148 in third_party/google-perftools-1.8.3/src/base/spinlock.h.'>SpinLockHolder</a> <a href='../Y/2604.html' title='Multiple used in 127 places.'>h</a>(&amp;<a href='../Y/4128.html' title='Multiple used in 3 places.'>patch_all_modules_lock</a>);
<a id='L707' name='L707' />    <strong class='reserved'>if</strong> (!<a href='../Y/2514.html' title='Multiple used in 4 places.'>g_last_loaded</a>)  <a href='../Y/2514.html' title='Multiple used in 4 places.'>g_last_loaded</a> = <strong class='reserved'>new</strong> <a href='../Y/5100.html' title='Multiple used in 181 places.'>std</a>::<a href='../Y/4774.html' title='Multiple used in 124 places.'>set</a>&lt;<a href='../Y/351.html' title='Multiple used in 18 places.'>HMODULE</a>&gt;;
<a id='L708' name='L708' />    <em class='comment'>// At the end of this loop, currently_loaded_modules contains the</em>
<a id='L709' name='L709' />    <em class='comment'>// full list of EnumProcessModules, and hModules just the ones we</em>
<a id='L710' name='L710' />    <em class='comment'>// haven't handled yet.</em>
<a id='L711' name='L711' />    <strong class='reserved'>for</strong> (<strong class='reserved'>int</strong> <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> = 0; <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> &lt; <a href='../Y/3874.html' title='Multiple used in 9 places.'>num_modules</a>; ) <em class='brace'>{</em>
<a id='L712' name='L712' />      <a href='../Y/1938.html' title='Multiple used in 4 places.'>currently_loaded_modules</a>.<a href='../Y/2839.html' title='Multiple used in 12 places.'>insert</a>(<a href='../Y/2611.html' title='Multiple used in 7 places.'>hModules</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>]);
<a id='L713' name='L713' />      <strong class='reserved'>if</strong> (<a href='../Y/2514.html' title='Multiple used in 4 places.'>g_last_loaded</a>-&gt;<a href='../Y/1870.html' title='Multiple used in 157 places.'>count</a>(<a href='../Y/2611.html' title='Multiple used in 7 places.'>hModules</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>]) &gt; 0) <em class='brace'>{</em>
<a id='L714' name='L714' />        <a href='../Y/2611.html' title='Multiple used in 7 places.'>hModules</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>] = <a href='../Y/2611.html' title='Multiple used in 7 places.'>hModules</a>[--<a href='../Y/3874.html' title='Multiple used in 9 places.'>num_modules</a>];  <em class='comment'>// replace element i with tail</em>
<a id='L715' name='L715' />      <em class='brace'>}</em> <strong class='reserved'>else</strong> <em class='brace'>{</em>
<a id='L716' name='L716' />        <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>++;                                    <em class='comment'>// keep element i</em>
<a id='L717' name='L717' />      <em class='brace'>}</em>
<a id='L718' name='L718' />    <em class='brace'>}</em>
<a id='L719' name='L719' />    <em class='comment'>// Now we do the unpatching/invalidation.</em>
<a id='L720' name='L720' />    <strong class='reserved'>for</strong> (<strong class='reserved'>int</strong> <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> = 0; <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> &lt; <strong class='reserved'>sizeof</strong>(<a href='../Y/2516.html' title='Multiple used in 10 places.'>g_module_libcs</a>)/<strong class='reserved'>sizeof</strong>(*<a href='../Y/2516.html' title='Multiple used in 10 places.'>g_module_libcs</a>); <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>++) <em class='brace'>{</em>
<a id='L721' name='L721' />      <strong class='reserved'>if</strong> (<a href='../Y/2516.html' title='Multiple used in 10 places.'>g_module_libcs</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>]-&gt;<a href='../S/684.html#L153' title='Defined at 153 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>patched</a>() &amp;&amp;
<a id='L722' name='L722' />          <a href='../Y/1938.html' title='Multiple used in 4 places.'>currently_loaded_modules</a>.<a href='../Y/1870.html' title='Multiple used in 157 places.'>count</a>(<a href='../Y/2516.html' title='Multiple used in 10 places.'>g_module_libcs</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>]-&gt;<a href='../S/684.html#L158' title='Defined at 158 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>hmodule</a>()) == 0) <em class='brace'>{</em>
<a id='L723' name='L723' />        <em class='comment'>// Means g_module_libcs[i] is no longer loaded (no me32 matched).</em>
<a id='L724' name='L724' />        <em class='comment'>// We could call Unpatch() here, but why bother?  The module</em>
<a id='L725' name='L725' />        <em class='comment'>// has gone away, so nobody is going to call into it anyway.</em>
<a id='L726' name='L726' />        <a href='../Y/2516.html' title='Multiple used in 10 places.'>g_module_libcs</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>]-&gt;<a href='../S/684.html#L154' title='Defined at 154 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>set_is_valid</a>(<strong class='reserved'>false</strong>);
<a id='L727' name='L727' />        <a href='../Y/3377.html' title='Multiple used in 5 places.'>made_changes</a> = <strong class='reserved'>true</strong>;
<a id='L728' name='L728' />      <em class='brace'>}</em>
<a id='L729' name='L729' />    <em class='brace'>}</em>
<a id='L730' name='L730' />    <em class='comment'>// Update the loaded module cache.</em>
<a id='L731' name='L731' />    <a href='../Y/2514.html' title='Multiple used in 4 places.'>g_last_loaded</a>-&gt;<a href='../Y/5185.html' title='Multiple used in 5 places.'>swap</a>(<a href='../Y/1938.html' title='Multiple used in 4 places.'>currently_loaded_modules</a>);
<a id='L732' name='L732' />  <em class='brace'>}</em>
<a id='L733' name='L733' />
<a id='L734' name='L734' />  <em class='comment'>// Now that we know what modules are new, let's get the info we'll</em>
<a id='L735' name='L735' />  <em class='comment'>// need to patch them.  Note this *cannot* be done while holding the</em>
<a id='L736' name='L736' />  <em class='comment'>// lock, since it needs to make windows calls (see the lock-inversion</em>
<a id='L737' name='L737' />  <em class='comment'>// comments before the definition of patch_all_modules_lock).</em>
<a id='L738' name='L738' />  <a href='../Y/478.html' title='Multiple used in 2 places.'>MODULEINFO</a> <a href='../Y/3529.html' title='Multiple used in 8 places.'>mi</a>;
<a id='L739' name='L739' />  <strong class='reserved'>for</strong> (<strong class='reserved'>int</strong> <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> = 0; <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a> &lt; <a href='../Y/3874.html' title='Multiple used in 9 places.'>num_modules</a>; <a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>++) <em class='brace'>{</em>
<a id='L740' name='L740' />    <strong class='reserved'>if</strong> (::GetModuleInformation(<a href='../Y/2605.html' title='Multiple used in 3 places.'>hCurrentProcess</a>, <a href='../Y/2611.html' title='Multiple used in 7 places.'>hModules</a>[<a href='../Y/2740.html' title='Multiple used in 2304 places.'>i</a>], &amp;<a href='../Y/3529.html' title='Multiple used in 8 places.'>mi</a>, <strong class='reserved'>sizeof</strong>(<a href='../Y/3529.html' title='Multiple used in 8 places.'>mi</a>)))
<a id='L741' name='L741' />      <a href='../Y/3596.html' title='Multiple used in 12 places.'>modules</a>.<a href='../Y/4391.html' title='Multiple used in 44 places.'>push_back</a>(<a href='../S/684.html#L291' title='Defined at 291 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>ModuleEntryCopy</a>(<a href='../Y/3529.html' title='Multiple used in 8 places.'>mi</a>));
<a id='L742' name='L742' />  <em class='brace'>}</em>
<a id='L743' name='L743' />
<a id='L744' name='L744' />  <em class='comment'>// Now we can do the patching of new modules.</em>
<a id='L745' name='L745' />  <em class='brace'>{</em>
<a id='L746' name='L746' />    <a href='../S/534.html#L148' title='Defined at 148 in third_party/google-perftools-1.8.3/src/base/spinlock.h.'>SpinLockHolder</a> <a href='../Y/2604.html' title='Multiple used in 127 places.'>h</a>(&amp;<a href='../Y/4128.html' title='Multiple used in 3 places.'>patch_all_modules_lock</a>);
<a id='L747' name='L747' />    <strong class='reserved'>for</strong> (<a href='../Y/5100.html' title='Multiple used in 181 places.'>std</a>::<a href='../Y/5622.html' title='Multiple used in 63 places.'>vector</a>&lt;<a href='../S/684.html#L291' title='Defined at 291 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>ModuleEntryCopy</a>&gt;::<a href='../Y/2943.html' title='Multiple used in 12 places.'>iterator</a> <a href='../Y/2934.html' title='Multiple used in 113 places.'>it</a> = <a href='../Y/3596.html' title='Multiple used in 12 places.'>modules</a>.<a href='../S/521.html#L382' title='Defined at 382 in third_party/google-perftools-1.8.3/src/base/elf_mem_image.cc.'>begin</a>();
<a id='L748' name='L748' />         <a href='../Y/2934.html' title='Multiple used in 113 places.'>it</a> != <a href='../Y/3596.html' title='Multiple used in 12 places.'>modules</a>.<a href='../S/521.html#L388' title='Defined at 388 in third_party/google-perftools-1.8.3/src/base/elf_mem_image.cc.'>end</a>(); ++<a href='../Y/2934.html' title='Multiple used in 113 places.'>it</a>) <em class='brace'>{</em>
<a id='L749' name='L749' />      <a href='../S/684.html#L147' title='Defined at 147 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfo</a> <a href='../Y/3233.html' title='Multiple used in 3 places.'>libc_info</a>;
<a id='L750' name='L750' />      <strong class='reserved'>if</strong> (<a href='../Y/3233.html' title='Multiple used in 3 places.'>libc_info</a>.<a href='../Y/646.html' title='Multiple used in 4 places.'>PopulateWindowsFn</a>(*<a href='../Y/2934.html' title='Multiple used in 113 places.'>it</a>)) <em class='brace'>{</em> <em class='comment'>// true==module has libc routines</em>
<a id='L751' name='L751' />        <a href='../Y/639.html' title='Multiple used in 2 places.'>PatchOneModuleLocked</a>(<a href='../Y/3233.html' title='Multiple used in 3 places.'>libc_info</a>);
<a id='L752' name='L752' />        <a href='../Y/3377.html' title='Multiple used in 5 places.'>made_changes</a> = <strong class='reserved'>true</strong>;
<a id='L753' name='L753' />      <em class='brace'>}</em>
<a id='L754' name='L754' />    <em class='brace'>}</em>
<a id='L755' name='L755' />
<a id='L756' name='L756' />    <em class='comment'>// Now that we've dealt with the modules (dlls), update the main</em>
<a id='L757' name='L757' />    <em class='comment'>// executable.  We do this last because PatchMainExecutableLocked</em>
<a id='L758' name='L758' />    <em class='comment'>// wants to look at how other modules were patched.</em>
<a id='L759' name='L759' />    <strong class='reserved'>if</strong> (!<a href='../Y/3382.html' title='Multiple used in 6 places.'>main_executable</a>.<a href='../S/684.html#L153' title='Defined at 153 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>patched</a>()) <em class='brace'>{</em>
<a id='L760' name='L760' />      <a href='../Y/638.html' title='Multiple used in 2 places.'>PatchMainExecutableLocked</a>();
<a id='L761' name='L761' />      <a href='../Y/3377.html' title='Multiple used in 5 places.'>made_changes</a> = <strong class='reserved'>true</strong>;
<a id='L762' name='L762' />    <em class='brace'>}</em>
<a id='L763' name='L763' />  <em class='brace'>}</em>
<a id='L764' name='L764' />  <em class='comment'>// TODO(csilvers): for this to be reliable, we need to also take</em>
<a id='L765' name='L765' />  <em class='comment'>// into account if we *would* have patched any modules had they not</em>
<a id='L766' name='L766' />  <em class='comment'>// already been loaded.  (That is, made_changes should ignore</em>
<a id='L767' name='L767' />  <em class='comment'>// g_last_loaded.)</em>
<a id='L768' name='L768' />  <strong class='reserved'>return</strong> <a href='../Y/3377.html' title='Multiple used in 5 places.'>made_changes</a>;
<a id='L769' name='L769' /><em class='brace'>}</em>
<a id='L770' name='L770' />
<a id='L771' name='L771' />
<a id='L772' name='L772' /><em class='brace'>}</em>  <em class='comment'>// end unnamed namespace</em>
<a id='L773' name='L773' />
<a id='L774' name='L774' /><em class='comment'>// ---------------------------------------------------------------------</em>
<a id='L775' name='L775' /><em class='comment'>// Now that we've done all the patching machinery, let's actually</em>
<a id='L776' name='L776' /><em class='comment'>// define the functions we're patching in.  Mostly these are</em>
<a id='L777' name='L777' /><em class='comment'>// simple wrappers around the do_* routines in tcmalloc.cc.</em>
<a id='L778' name='L778' /><em class='comment'>//</em>
<a id='L779' name='L779' /><em class='comment'>// In fact, we #include tcmalloc.cc to get at the tcmalloc internal</em>
<a id='L780' name='L780' /><em class='comment'>// do_* functions, the better to write our own hook functions.</em>
<a id='L781' name='L781' /><em class='comment'>// U-G-L-Y, I know.  But the alternatives are, perhaps, worse.  This</em>
<a id='L782' name='L782' /><em class='comment'>// also lets us define _msize(), _expand(), and other windows-specific</em>
<a id='L783' name='L783' /><em class='comment'>// functions here, using tcmalloc internals, without polluting</em>
<a id='L784' name='L784' /><em class='comment'>// tcmalloc.cc.</em>
<a id='L785' name='L785' /><em class='comment'>// -------------------------------------------------------------------</em>
<a id='L786' name='L786' />
<a id='L787' name='L787' /><em class='comment'>// TODO(csilvers): refactor tcmalloc.cc into two files, so I can link</em>
<a id='L788' name='L788' /><em class='comment'>// against the file with do_malloc, and ignore the one with malloc.</em>
<a id='L789' name='L789' /><em class='sharp'>#include</em> "tcmalloc.cc"
<a id='L790' name='L790' />
<a id='L791' name='L791' /><strong class='reserved'>template</strong>&lt;<strong class='reserved'>int</strong> <a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;
<a id='L792' name='L792' /><strong class='reserved'>void</strong>* <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;<a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;::<a href='../R/1955.html' title='Multiple refered from 2 places.'>Perftools_malloc</a>(<a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a> <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>) <a href='../D/3265.html' title='Multiple defined in 10 places.'>__THROW</a> <em class='brace'>{</em>
<a id='L793' name='L793' />  <strong class='reserved'>void</strong>* <a href='../Y/4529.html' title='Multiple used in 474 places.'>result</a> = <a href='../S/626.html#L1001' title='Defined at 1001 in third_party/google-perftools-1.8.3/src/tcmalloc.cc.'>do_malloc_or_cpp_alloc</a>(<a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>);
<a id='L794' name='L794' />  <a href='../Y/501.html' title='Multiple used in 224 places.'>MallocHook</a>::<a href='../S/581.html#L159' title='Defined at 159 in third_party/google-perftools-1.8.3/src/malloc_hook-inl.h.'>InvokeNewHook</a>(<a href='../Y/4529.html' title='Multiple used in 474 places.'>result</a>, <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>);
<a id='L795' name='L795' />  <strong class='reserved'>return</strong> <a href='../Y/4529.html' title='Multiple used in 474 places.'>result</a>;
<a id='L796' name='L796' /><em class='brace'>}</em>
<a id='L797' name='L797' />
<a id='L798' name='L798' /><strong class='reserved'>template</strong>&lt;<strong class='reserved'>int</strong> <a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;
<a id='L799' name='L799' /><strong class='reserved'>void</strong> <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;<a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;::<a href='../R/1954.html' title='Multiple refered from 2 places.'>Perftools_free</a>(<strong class='reserved'>void</strong>* <a href='../Y/4374.html' title='Multiple used in 1186 places.'>ptr</a>) <a href='../D/3265.html' title='Multiple defined in 10 places.'>__THROW</a> <em class='brace'>{</em>
<a id='L800' name='L800' />  <a href='../Y/501.html' title='Multiple used in 224 places.'>MallocHook</a>::<a href='../S/581.html#L174' title='Defined at 174 in third_party/google-perftools-1.8.3/src/malloc_hook-inl.h.'>InvokeDeleteHook</a>(<a href='../Y/4374.html' title='Multiple used in 1186 places.'>ptr</a>);
<a id='L801' name='L801' />  <em class='comment'>// This calls the windows free if do_free decides ptr was not</em>
<a id='L802' name='L802' />  <em class='comment'>// allocated by tcmalloc.  Note it calls the origstub_free from</em>
<a id='L803' name='L803' />  <em class='comment'>// *this* templatized instance of LibcInfo.  See "template</em>
<a id='L804' name='L804' />  <em class='comment'>// trickiness" above.</em>
<a id='L805' name='L805' />  <a href='../S/626.html#L1093' title='Defined at 1093 in third_party/google-perftools-1.8.3/src/tcmalloc.cc.'>do_free_with_callback</a>(<a href='../Y/4374.html' title='Multiple used in 1186 places.'>ptr</a>, (<strong class='reserved'>void</strong> (*)(<strong class='reserved'>void</strong>*))<a href='../Y/4041.html' title='Multiple used in 15 places.'>origstub_fn_</a>[<a href='../S/684.html#L179' title='Defined at 179 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kFree</a>]);
<a id='L806' name='L806' /><em class='brace'>}</em>
<a id='L807' name='L807' />
<a id='L808' name='L808' /><strong class='reserved'>template</strong>&lt;<strong class='reserved'>int</strong> <a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;
<a id='L809' name='L809' /><strong class='reserved'>void</strong>* <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;<a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;::<a href='../R/1960.html' title='Multiple refered from 2 places.'>Perftools_realloc</a>(
<a id='L810' name='L810' />    <strong class='reserved'>void</strong>* <a href='../Y/3943.html' title='Multiple used in 22 places.'>old_ptr</a>, <a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a> <a href='../S/404.html#L85' title='Defined at 85 in src/utility/st.c.'>new_size</a>) <a href='../D/3265.html' title='Multiple defined in 10 places.'>__THROW</a> <em class='brace'>{</em>
<a id='L811' name='L811' />  <strong class='reserved'>if</strong> (<a href='../Y/3943.html' title='Multiple used in 22 places.'>old_ptr</a> == <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>) <em class='brace'>{</em>
<a id='L812' name='L812' />    <strong class='reserved'>void</strong>* <a href='../Y/4529.html' title='Multiple used in 474 places.'>result</a> = <a href='../S/626.html#L1001' title='Defined at 1001 in third_party/google-perftools-1.8.3/src/tcmalloc.cc.'>do_malloc_or_cpp_alloc</a>(<a href='../S/404.html#L85' title='Defined at 85 in src/utility/st.c.'>new_size</a>);
<a id='L813' name='L813' />    <a href='../Y/501.html' title='Multiple used in 224 places.'>MallocHook</a>::<a href='../S/581.html#L159' title='Defined at 159 in third_party/google-perftools-1.8.3/src/malloc_hook-inl.h.'>InvokeNewHook</a>(<a href='../Y/4529.html' title='Multiple used in 474 places.'>result</a>, <a href='../S/404.html#L85' title='Defined at 85 in src/utility/st.c.'>new_size</a>);
<a id='L814' name='L814' />    <strong class='reserved'>return</strong> <a href='../Y/4529.html' title='Multiple used in 474 places.'>result</a>;
<a id='L815' name='L815' />  <em class='brace'>}</em>
<a id='L816' name='L816' />  <strong class='reserved'>if</strong> (<a href='../S/404.html#L85' title='Defined at 85 in src/utility/st.c.'>new_size</a> == 0) <em class='brace'>{</em>
<a id='L817' name='L817' />    <a href='../Y/501.html' title='Multiple used in 224 places.'>MallocHook</a>::<a href='../S/581.html#L174' title='Defined at 174 in third_party/google-perftools-1.8.3/src/malloc_hook-inl.h.'>InvokeDeleteHook</a>(<a href='../Y/3943.html' title='Multiple used in 22 places.'>old_ptr</a>);
<a id='L818' name='L818' />    <a href='../S/626.html#L1093' title='Defined at 1093 in third_party/google-perftools-1.8.3/src/tcmalloc.cc.'>do_free_with_callback</a>(<a href='../Y/3943.html' title='Multiple used in 22 places.'>old_ptr</a>,
<a id='L819' name='L819' />                          (<strong class='reserved'>void</strong> (*)(<strong class='reserved'>void</strong>*))<a href='../Y/4041.html' title='Multiple used in 15 places.'>origstub_fn_</a>[<a href='../S/684.html#L179' title='Defined at 179 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kFree</a>]);
<a id='L820' name='L820' />    <strong class='reserved'>return</strong> <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>;
<a id='L821' name='L821' />  <em class='brace'>}</em>
<a id='L822' name='L822' />  <strong class='reserved'>return</strong> <a href='../S/626.html#L1170' title='Defined at 1170 in third_party/google-perftools-1.8.3/src/tcmalloc.cc.'>do_realloc_with_callback</a>(
<a id='L823' name='L823' />      <a href='../Y/3943.html' title='Multiple used in 22 places.'>old_ptr</a>, <a href='../S/404.html#L85' title='Defined at 85 in src/utility/st.c.'>new_size</a>,
<a id='L824' name='L824' />      (<strong class='reserved'>void</strong> (*)(<strong class='reserved'>void</strong>*))<a href='../Y/4041.html' title='Multiple used in 15 places.'>origstub_fn_</a>[<a href='../S/684.html#L179' title='Defined at 179 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kFree</a>],
<a id='L825' name='L825' />      (<a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a> (*)(<strong class='reserved'>void</strong>*))<a href='../Y/4041.html' title='Multiple used in 15 places.'>origstub_fn_</a>[<a href='../S/684.html#L183' title='Defined at 183 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>k_Msize</a>]);
<a id='L826' name='L826' /><em class='brace'>}</em>
<a id='L827' name='L827' />
<a id='L828' name='L828' /><strong class='reserved'>template</strong>&lt;<strong class='reserved'>int</strong> <a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;
<a id='L829' name='L829' /><strong class='reserved'>void</strong>* <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;<a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;::<a href='../R/1949.html' title='Multiple refered from 2 places.'>Perftools_calloc</a>(
<a id='L830' name='L830' />    <a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a> <a href='../Y/3648.html' title='Multiple used in 868 places.'>n</a>, <a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a> <a href='../Y/2162.html' title='Multiple used in 9 places.'>elem_size</a>) <a href='../D/3265.html' title='Multiple defined in 10 places.'>__THROW</a> <em class='brace'>{</em>
<a id='L831' name='L831' />  <strong class='reserved'>void</strong>* <a href='../Y/4529.html' title='Multiple used in 474 places.'>result</a> = <a href='../S/626.html#L1074' title='Defined at 1074 in third_party/google-perftools-1.8.3/src/tcmalloc.cc.'>do_calloc</a>(<a href='../Y/3648.html' title='Multiple used in 868 places.'>n</a>, <a href='../Y/2162.html' title='Multiple used in 9 places.'>elem_size</a>);
<a id='L832' name='L832' />  <a href='../Y/501.html' title='Multiple used in 224 places.'>MallocHook</a>::<a href='../S/581.html#L159' title='Defined at 159 in third_party/google-perftools-1.8.3/src/malloc_hook-inl.h.'>InvokeNewHook</a>(<a href='../Y/4529.html' title='Multiple used in 474 places.'>result</a>, <a href='../Y/3648.html' title='Multiple used in 868 places.'>n</a> * <a href='../Y/2162.html' title='Multiple used in 9 places.'>elem_size</a>);
<a id='L833' name='L833' />  <strong class='reserved'>return</strong> <a href='../Y/4529.html' title='Multiple used in 474 places.'>result</a>;
<a id='L834' name='L834' /><em class='brace'>}</em>
<a id='L835' name='L835' />
<a id='L836' name='L836' /><strong class='reserved'>template</strong>&lt;<strong class='reserved'>int</strong> <a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;
<a id='L837' name='L837' /><strong class='reserved'>void</strong>* <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;<a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;::<a href='../R/1956.html' title='Multiple refered from 2 places.'>Perftools_new</a>(<a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a> <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>) <em class='brace'>{</em>
<a id='L838' name='L838' />  <strong class='reserved'>void</strong>* <a href='../Y/4073.html' title='Multiple used in 1292 places.'>p</a> = <a href='../S/626.html#L1341' title='Defined at 1341 in third_party/google-perftools-1.8.3/src/tcmalloc.cc.'>cpp_alloc</a>(<a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>, <strong class='reserved'>false</strong>);
<a id='L839' name='L839' />  <a href='../Y/501.html' title='Multiple used in 224 places.'>MallocHook</a>::<a href='../S/581.html#L159' title='Defined at 159 in third_party/google-perftools-1.8.3/src/malloc_hook-inl.h.'>InvokeNewHook</a>(<a href='../Y/4073.html' title='Multiple used in 1292 places.'>p</a>, <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>);
<a id='L840' name='L840' />  <strong class='reserved'>return</strong> <a href='../Y/4073.html' title='Multiple used in 1292 places.'>p</a>;
<a id='L841' name='L841' /><em class='brace'>}</em>
<a id='L842' name='L842' />
<a id='L843' name='L843' /><strong class='reserved'>template</strong>&lt;<strong class='reserved'>int</strong> <a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;
<a id='L844' name='L844' /><strong class='reserved'>void</strong>* <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;<a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;::<a href='../R/1958.html' title='Multiple refered from 2 places.'>Perftools_newarray</a>(<a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a> <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>) <em class='brace'>{</em>
<a id='L845' name='L845' />  <strong class='reserved'>void</strong>* <a href='../Y/4073.html' title='Multiple used in 1292 places.'>p</a> = <a href='../S/626.html#L1341' title='Defined at 1341 in third_party/google-perftools-1.8.3/src/tcmalloc.cc.'>cpp_alloc</a>(<a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>, <strong class='reserved'>false</strong>);
<a id='L846' name='L846' />  <a href='../Y/501.html' title='Multiple used in 224 places.'>MallocHook</a>::<a href='../S/581.html#L159' title='Defined at 159 in third_party/google-perftools-1.8.3/src/malloc_hook-inl.h.'>InvokeNewHook</a>(<a href='../Y/4073.html' title='Multiple used in 1292 places.'>p</a>, <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>);
<a id='L847' name='L847' />  <strong class='reserved'>return</strong> <a href='../Y/4073.html' title='Multiple used in 1292 places.'>p</a>;
<a id='L848' name='L848' /><em class='brace'>}</em>
<a id='L849' name='L849' />
<a id='L850' name='L850' /><strong class='reserved'>template</strong>&lt;<strong class='reserved'>int</strong> <a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;
<a id='L851' name='L851' /><strong class='reserved'>void</strong> <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;<a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;::<a href='../R/1950.html' title='Multiple refered from 2 places.'>Perftools_delete</a>(<strong class='reserved'>void</strong> *<a href='../Y/4073.html' title='Multiple used in 1292 places.'>p</a>) <em class='brace'>{</em>
<a id='L852' name='L852' />  <a href='../Y/501.html' title='Multiple used in 224 places.'>MallocHook</a>::<a href='../S/581.html#L174' title='Defined at 174 in third_party/google-perftools-1.8.3/src/malloc_hook-inl.h.'>InvokeDeleteHook</a>(<a href='../Y/4073.html' title='Multiple used in 1292 places.'>p</a>);
<a id='L853' name='L853' />  <a href='../S/626.html#L1093' title='Defined at 1093 in third_party/google-perftools-1.8.3/src/tcmalloc.cc.'>do_free_with_callback</a>(<a href='../Y/4073.html' title='Multiple used in 1292 places.'>p</a>, (<strong class='reserved'>void</strong> (*)(<strong class='reserved'>void</strong>*))<a href='../Y/4041.html' title='Multiple used in 15 places.'>origstub_fn_</a>[<a href='../S/684.html#L179' title='Defined at 179 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kFree</a>]);
<a id='L854' name='L854' /><em class='brace'>}</em>
<a id='L855' name='L855' />
<a id='L856' name='L856' /><strong class='reserved'>template</strong>&lt;<strong class='reserved'>int</strong> <a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;
<a id='L857' name='L857' /><strong class='reserved'>void</strong> <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;<a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;::<a href='../R/1952.html' title='Multiple refered from 2 places.'>Perftools_deletearray</a>(<strong class='reserved'>void</strong> *<a href='../Y/4073.html' title='Multiple used in 1292 places.'>p</a>) <em class='brace'>{</em>
<a id='L858' name='L858' />  <a href='../Y/501.html' title='Multiple used in 224 places.'>MallocHook</a>::<a href='../S/581.html#L174' title='Defined at 174 in third_party/google-perftools-1.8.3/src/malloc_hook-inl.h.'>InvokeDeleteHook</a>(<a href='../Y/4073.html' title='Multiple used in 1292 places.'>p</a>);
<a id='L859' name='L859' />  <a href='../S/626.html#L1093' title='Defined at 1093 in third_party/google-perftools-1.8.3/src/tcmalloc.cc.'>do_free_with_callback</a>(<a href='../Y/4073.html' title='Multiple used in 1292 places.'>p</a>, (<strong class='reserved'>void</strong> (*)(<strong class='reserved'>void</strong>*))<a href='../Y/4041.html' title='Multiple used in 15 places.'>origstub_fn_</a>[<a href='../S/684.html#L179' title='Defined at 179 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kFree</a>]);
<a id='L860' name='L860' /><em class='brace'>}</em>
<a id='L861' name='L861' />
<a id='L862' name='L862' /><strong class='reserved'>template</strong>&lt;<strong class='reserved'>int</strong> <a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;
<a id='L863' name='L863' /><strong class='reserved'>void</strong>* <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;<a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;::<a href='../R/1957.html' title='Multiple refered from 2 places.'>Perftools_new_nothrow</a>(
<a id='L864' name='L864' />    <a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a> <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>, <strong class='reserved'>const</strong> <a href='../Y/5100.html' title='Multiple used in 181 places.'>std</a>::<a href='../Y/3844.html' title='Multiple used in 48 places.'>nothrow_t</a>&amp;) <a href='../D/3265.html' title='Multiple defined in 10 places.'>__THROW</a> <em class='brace'>{</em>
<a id='L865' name='L865' />  <strong class='reserved'>void</strong>* <a href='../Y/4073.html' title='Multiple used in 1292 places.'>p</a> = <a href='../S/626.html#L1341' title='Defined at 1341 in third_party/google-perftools-1.8.3/src/tcmalloc.cc.'>cpp_alloc</a>(<a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>, <strong class='reserved'>true</strong>);
<a id='L866' name='L866' />  <a href='../Y/501.html' title='Multiple used in 224 places.'>MallocHook</a>::<a href='../S/581.html#L159' title='Defined at 159 in third_party/google-perftools-1.8.3/src/malloc_hook-inl.h.'>InvokeNewHook</a>(<a href='../Y/4073.html' title='Multiple used in 1292 places.'>p</a>, <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>);
<a id='L867' name='L867' />  <strong class='reserved'>return</strong> <a href='../Y/4073.html' title='Multiple used in 1292 places.'>p</a>;
<a id='L868' name='L868' /><em class='brace'>}</em>
<a id='L869' name='L869' />
<a id='L870' name='L870' /><strong class='reserved'>template</strong>&lt;<strong class='reserved'>int</strong> <a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;
<a id='L871' name='L871' /><strong class='reserved'>void</strong>* <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;<a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;::<a href='../R/1959.html' title='Multiple refered from 2 places.'>Perftools_newarray_nothrow</a>(
<a id='L872' name='L872' />    <a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a> <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>, <strong class='reserved'>const</strong> <a href='../Y/5100.html' title='Multiple used in 181 places.'>std</a>::<a href='../Y/3844.html' title='Multiple used in 48 places.'>nothrow_t</a>&amp;) <a href='../D/3265.html' title='Multiple defined in 10 places.'>__THROW</a> <em class='brace'>{</em>
<a id='L873' name='L873' />  <strong class='reserved'>void</strong>* <a href='../Y/4073.html' title='Multiple used in 1292 places.'>p</a> = <a href='../S/626.html#L1341' title='Defined at 1341 in third_party/google-perftools-1.8.3/src/tcmalloc.cc.'>cpp_alloc</a>(<a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>, <strong class='reserved'>true</strong>);
<a id='L874' name='L874' />  <a href='../Y/501.html' title='Multiple used in 224 places.'>MallocHook</a>::<a href='../S/581.html#L159' title='Defined at 159 in third_party/google-perftools-1.8.3/src/malloc_hook-inl.h.'>InvokeNewHook</a>(<a href='../Y/4073.html' title='Multiple used in 1292 places.'>p</a>, <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>);
<a id='L875' name='L875' />  <strong class='reserved'>return</strong> <a href='../Y/4073.html' title='Multiple used in 1292 places.'>p</a>;
<a id='L876' name='L876' /><em class='brace'>}</em>
<a id='L877' name='L877' />
<a id='L878' name='L878' /><strong class='reserved'>template</strong>&lt;<strong class='reserved'>int</strong> <a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;
<a id='L879' name='L879' /><strong class='reserved'>void</strong> <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;<a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;::<a href='../R/1951.html' title='Multiple refered from 2 places.'>Perftools_delete_nothrow</a>(
<a id='L880' name='L880' />    <strong class='reserved'>void</strong> *<a href='../Y/4073.html' title='Multiple used in 1292 places.'>p</a>, <strong class='reserved'>const</strong> <a href='../Y/5100.html' title='Multiple used in 181 places.'>std</a>::<a href='../Y/3844.html' title='Multiple used in 48 places.'>nothrow_t</a>&amp;) <a href='../D/3265.html' title='Multiple defined in 10 places.'>__THROW</a> <em class='brace'>{</em>
<a id='L881' name='L881' />  <a href='../Y/501.html' title='Multiple used in 224 places.'>MallocHook</a>::<a href='../S/581.html#L174' title='Defined at 174 in third_party/google-perftools-1.8.3/src/malloc_hook-inl.h.'>InvokeDeleteHook</a>(<a href='../Y/4073.html' title='Multiple used in 1292 places.'>p</a>);
<a id='L882' name='L882' />  <a href='../S/626.html#L1093' title='Defined at 1093 in third_party/google-perftools-1.8.3/src/tcmalloc.cc.'>do_free_with_callback</a>(<a href='../Y/4073.html' title='Multiple used in 1292 places.'>p</a>, (<strong class='reserved'>void</strong> (*)(<strong class='reserved'>void</strong>*))<a href='../Y/4041.html' title='Multiple used in 15 places.'>origstub_fn_</a>[<a href='../S/684.html#L179' title='Defined at 179 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kFree</a>]);
<a id='L883' name='L883' /><em class='brace'>}</em>
<a id='L884' name='L884' />
<a id='L885' name='L885' /><strong class='reserved'>template</strong>&lt;<strong class='reserved'>int</strong> <a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;
<a id='L886' name='L886' /><strong class='reserved'>void</strong> <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;<a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;::<a href='../R/1953.html' title='Multiple refered from 2 places.'>Perftools_deletearray_nothrow</a>(
<a id='L887' name='L887' />    <strong class='reserved'>void</strong> *<a href='../Y/4073.html' title='Multiple used in 1292 places.'>p</a>, <strong class='reserved'>const</strong> <a href='../Y/5100.html' title='Multiple used in 181 places.'>std</a>::<a href='../Y/3844.html' title='Multiple used in 48 places.'>nothrow_t</a>&amp;) <a href='../D/3265.html' title='Multiple defined in 10 places.'>__THROW</a> <em class='brace'>{</em>
<a id='L888' name='L888' />  <a href='../Y/501.html' title='Multiple used in 224 places.'>MallocHook</a>::<a href='../S/581.html#L174' title='Defined at 174 in third_party/google-perftools-1.8.3/src/malloc_hook-inl.h.'>InvokeDeleteHook</a>(<a href='../Y/4073.html' title='Multiple used in 1292 places.'>p</a>);
<a id='L889' name='L889' />  <a href='../S/626.html#L1093' title='Defined at 1093 in third_party/google-perftools-1.8.3/src/tcmalloc.cc.'>do_free_with_callback</a>(<a href='../Y/4073.html' title='Multiple used in 1292 places.'>p</a>, (<strong class='reserved'>void</strong> (*)(<strong class='reserved'>void</strong>*))<a href='../Y/4041.html' title='Multiple used in 15 places.'>origstub_fn_</a>[<a href='../S/684.html#L179' title='Defined at 179 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kFree</a>]);
<a id='L890' name='L890' /><em class='brace'>}</em>
<a id='L891' name='L891' />
<a id='L892' name='L892' />
<a id='L893' name='L893' /><em class='comment'>// _msize() lets you figure out how much space is reserved for a</em>
<a id='L894' name='L894' /><em class='comment'>// pointer, in Windows.  Even if applications don't call it, any DLL</em>
<a id='L895' name='L895' /><em class='comment'>// with global constructors will call (transitively) something called</em>
<a id='L896' name='L896' /><em class='comment'>// __dllonexit_lk in order to make sure the destructors get called</em>
<a id='L897' name='L897' /><em class='comment'>// when the dll unloads.  And that will call msize -- horrible things</em>
<a id='L898' name='L898' /><em class='comment'>// can ensue if this is not hooked.  Other parts of libc may also call</em>
<a id='L899' name='L899' /><em class='comment'>// this internally.</em>
<a id='L900' name='L900' />
<a id='L901' name='L901' /><strong class='reserved'>template</strong>&lt;<strong class='reserved'>int</strong> <a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;
<a id='L902' name='L902' /><a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a> <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;<a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;::<a href='../R/1948.html' title='Multiple refered from 2 places.'>Perftools__msize</a>(<strong class='reserved'>void</strong>* <a href='../Y/4374.html' title='Multiple used in 1186 places.'>ptr</a>) <a href='../D/3265.html' title='Multiple defined in 10 places.'>__THROW</a> <em class='brace'>{</em>
<a id='L903' name='L903' />  <strong class='reserved'>return</strong> <a href='../S/626.html#L1147' title='Defined at 1147 in third_party/google-perftools-1.8.3/src/tcmalloc.cc.'>GetSizeWithCallback</a>(<a href='../Y/4374.html' title='Multiple used in 1186 places.'>ptr</a>, (<a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a> (*)(<strong class='reserved'>void</strong>*))<a href='../Y/4041.html' title='Multiple used in 15 places.'>origstub_fn_</a>[<a href='../S/684.html#L183' title='Defined at 183 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>k_Msize</a>]);
<a id='L904' name='L904' /><em class='brace'>}</em>
<a id='L905' name='L905' />
<a id='L906' name='L906' /><em class='comment'>// We need to define this because internal windows functions like to</em>
<a id='L907' name='L907' /><em class='comment'>// call into it(?).  _expand() is like realloc but doesn't move the</em>
<a id='L908' name='L908' /><em class='comment'>// pointer.  We punt, which will cause callers to fall back on realloc.</em>
<a id='L909' name='L909' /><strong class='reserved'>template</strong>&lt;<strong class='reserved'>int</strong> <a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;
<a id='L910' name='L910' /><strong class='reserved'>void</strong>* <a href='../S/684.html#L248' title='Defined at 248 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>LibcInfoWithPatchFunctions</a>&lt;<a href='../Y/845.html' title='Multiple used in 153 places.'>T</a>&gt;::<a href='../R/1947.html' title='Multiple refered from 2 places.'>Perftools__expand</a>(<strong class='reserved'>void</strong> *<a href='../Y/4374.html' title='Multiple used in 1186 places.'>ptr</a>,
<a id='L911' name='L911' />                                                       <a href='../D/5108.html' title='Multiple defined in 2 places.'>size_t</a> <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>) <a href='../D/3265.html' title='Multiple defined in 10 places.'>__THROW</a> <em class='brace'>{</em>
<a id='L912' name='L912' />  <strong class='reserved'>return</strong> <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>;
<a id='L913' name='L913' /><em class='brace'>}</em>
<a id='L914' name='L914' />
<a id='L915' name='L915' /><a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a> <a href='../Y/926.html' title='Multiple used in 29 places.'>WINAPI</a> <a href='../S/684.html#L325' title='Defined at 325 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>WindowsInfo</a>::<a href='../R/1940.html' title='Multiple refered from 2 places.'>Perftools_HeapAlloc</a>(<a href='../Y/331.html' title='Multiple used in 28 places.'>HANDLE</a> <a href='../Y/2609.html' title='Multiple used in 6 places.'>hHeap</a>, <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a> <a href='../Y/2125.html' title='Multiple used in 9 places.'>dwFlags</a>,
<a id='L916' name='L916' />                                               <a href='../Y/117.html' title='Multiple used in 4 places.'>DWORD_PTR</a> <a href='../Y/2121.html' title='Multiple used in 4 places.'>dwBytes</a>) <em class='brace'>{</em>
<a id='L917' name='L917' />  <a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a> <a href='../Y/4529.html' title='Multiple used in 474 places.'>result</a> = ((<a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a> (<a href='../Y/926.html' title='Multiple used in 29 places.'>WINAPI</a> *)(<a href='../Y/331.html' title='Multiple used in 28 places.'>HANDLE</a>, <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a>, <a href='../Y/117.html' title='Multiple used in 4 places.'>DWORD_PTR</a>))
<a id='L918' name='L918' />                   <a href='../Y/2493.html' title='Multiple used in 20 places.'>function_info_</a>[<a href='../S/684.html#L334' title='Defined at 334 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kHeapAlloc</a>].<a href='../Y/4040.html' title='Multiple used in 13 places.'>origstub_fn</a>)(
<a id='L919' name='L919' />                       <a href='../Y/2609.html' title='Multiple used in 6 places.'>hHeap</a>, <a href='../Y/2125.html' title='Multiple used in 9 places.'>dwFlags</a>, <a href='../Y/2121.html' title='Multiple used in 4 places.'>dwBytes</a>);
<a id='L920' name='L920' />  <a href='../Y/501.html' title='Multiple used in 224 places.'>MallocHook</a>::<a href='../S/581.html#L159' title='Defined at 159 in third_party/google-perftools-1.8.3/src/malloc_hook-inl.h.'>InvokeNewHook</a>(<a href='../Y/4529.html' title='Multiple used in 474 places.'>result</a>, <a href='../Y/2121.html' title='Multiple used in 4 places.'>dwBytes</a>);
<a id='L921' name='L921' />  <strong class='reserved'>return</strong> <a href='../Y/4529.html' title='Multiple used in 474 places.'>result</a>;
<a id='L922' name='L922' /><em class='brace'>}</em>
<a id='L923' name='L923' />
<a id='L924' name='L924' /><a href='../S/347.html#L62' title='Defined at 62 in src/lmntal.h.'>BOOL</a> <a href='../Y/926.html' title='Multiple used in 29 places.'>WINAPI</a> <a href='../S/684.html#L325' title='Defined at 325 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>WindowsInfo</a>::<a href='../R/1941.html' title='Multiple refered from 2 places.'>Perftools_HeapFree</a>(<a href='../Y/331.html' title='Multiple used in 28 places.'>HANDLE</a> <a href='../Y/2609.html' title='Multiple used in 6 places.'>hHeap</a>, <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a> <a href='../Y/2125.html' title='Multiple used in 9 places.'>dwFlags</a>,
<a id='L925' name='L925' />                                            <a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a> <a href='../Y/3345.html' title='Multiple used in 4 places.'>lpMem</a>) <em class='brace'>{</em>
<a id='L926' name='L926' />  <a href='../Y/501.html' title='Multiple used in 224 places.'>MallocHook</a>::<a href='../S/581.html#L174' title='Defined at 174 in third_party/google-perftools-1.8.3/src/malloc_hook-inl.h.'>InvokeDeleteHook</a>(<a href='../Y/3345.html' title='Multiple used in 4 places.'>lpMem</a>);
<a id='L927' name='L927' />  <strong class='reserved'>return</strong> ((<a href='../S/347.html#L62' title='Defined at 62 in src/lmntal.h.'>BOOL</a> (<a href='../Y/926.html' title='Multiple used in 29 places.'>WINAPI</a> *)(<a href='../Y/331.html' title='Multiple used in 28 places.'>HANDLE</a>, <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a>, <a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a>))
<a id='L928' name='L928' />          <a href='../Y/2493.html' title='Multiple used in 20 places.'>function_info_</a>[<a href='../S/684.html#L334' title='Defined at 334 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kHeapFree</a>].<a href='../Y/4040.html' title='Multiple used in 13 places.'>origstub_fn</a>)(
<a id='L929' name='L929' />              <a href='../Y/2609.html' title='Multiple used in 6 places.'>hHeap</a>, <a href='../Y/2125.html' title='Multiple used in 9 places.'>dwFlags</a>, <a href='../Y/3345.html' title='Multiple used in 4 places.'>lpMem</a>);
<a id='L930' name='L930' /><em class='brace'>}</em>
<a id='L931' name='L931' />
<a id='L932' name='L932' /><a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a> <a href='../Y/926.html' title='Multiple used in 29 places.'>WINAPI</a> <a href='../S/684.html#L325' title='Defined at 325 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>WindowsInfo</a>::<a href='../R/1945.html' title='Multiple refered from 2 places.'>Perftools_VirtualAllocEx</a>(<a href='../Y/331.html' title='Multiple used in 28 places.'>HANDLE</a> <a href='../Y/4278.html' title='Multiple used in 32 places.'>process</a>,
<a id='L933' name='L933' />                                                    <a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a> <a href='../Y/1411.html' title='Multiple used in 58 places.'>address</a>,
<a id='L934' name='L934' />                                                    <a href='../Y/733.html' title='Multiple used in 9 places.'>SIZE_T</a> <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>, <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a> <a href='../Y/5486.html' title='Multiple used in 318 places.'>type</a>,
<a id='L935' name='L935' />                                                    <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a> <a href='../Y/4327.html' title='Multiple used in 4 places.'>protect</a>) <em class='brace'>{</em>
<a id='L936' name='L936' />  <a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a> <a href='../Y/4529.html' title='Multiple used in 474 places.'>result</a> = ((<a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a> (<a href='../Y/926.html' title='Multiple used in 29 places.'>WINAPI</a> *)(<a href='../Y/331.html' title='Multiple used in 28 places.'>HANDLE</a>, <a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a>, <a href='../Y/733.html' title='Multiple used in 9 places.'>SIZE_T</a>, <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a>, <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a>))
<a id='L937' name='L937' />                   <a href='../Y/2493.html' title='Multiple used in 20 places.'>function_info_</a>[<a href='../S/684.html#L334' title='Defined at 334 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kVirtualAllocEx</a>].<a href='../Y/4040.html' title='Multiple used in 13 places.'>origstub_fn</a>)(
<a id='L938' name='L938' />                       <a href='../Y/4278.html' title='Multiple used in 32 places.'>process</a>, <a href='../Y/1411.html' title='Multiple used in 58 places.'>address</a>, <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>, <a href='../Y/5486.html' title='Multiple used in 318 places.'>type</a>, <a href='../Y/4327.html' title='Multiple used in 4 places.'>protect</a>);
<a id='L939' name='L939' />  <em class='comment'>// VirtualAllocEx() seems to be the Windows equivalent of mmap()</em>
<a id='L940' name='L940' />  <a href='../Y/501.html' title='Multiple used in 224 places.'>MallocHook</a>::<a href='../S/581.html#L211' title='Defined at 211 in third_party/google-perftools-1.8.3/src/malloc_hook-inl.h.'>InvokeMmapHook</a>(<a href='../Y/4529.html' title='Multiple used in 474 places.'>result</a>, <a href='../Y/1411.html' title='Multiple used in 58 places.'>address</a>, <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>, <a href='../Y/4327.html' title='Multiple used in 4 places.'>protect</a>, <a href='../Y/5486.html' title='Multiple used in 318 places.'>type</a>, -1, 0);
<a id='L941' name='L941' />  <strong class='reserved'>return</strong> <a href='../Y/4529.html' title='Multiple used in 474 places.'>result</a>;
<a id='L942' name='L942' /><em class='brace'>}</em>
<a id='L943' name='L943' />
<a id='L944' name='L944' /><a href='../S/347.html#L62' title='Defined at 62 in src/lmntal.h.'>BOOL</a> <a href='../Y/926.html' title='Multiple used in 29 places.'>WINAPI</a> <a href='../S/684.html#L325' title='Defined at 325 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>WindowsInfo</a>::<a href='../R/1946.html' title='Multiple refered from 2 places.'>Perftools_VirtualFreeEx</a>(<a href='../Y/331.html' title='Multiple used in 28 places.'>HANDLE</a> <a href='../Y/4278.html' title='Multiple used in 32 places.'>process</a>, <a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a> <a href='../Y/1411.html' title='Multiple used in 58 places.'>address</a>,
<a id='L945' name='L945' />                                                 <a href='../Y/733.html' title='Multiple used in 9 places.'>SIZE_T</a> <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>, <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a> <a href='../Y/5486.html' title='Multiple used in 318 places.'>type</a>) <em class='brace'>{</em>
<a id='L946' name='L946' />  <a href='../Y/501.html' title='Multiple used in 224 places.'>MallocHook</a>::<a href='../S/581.html#L251' title='Defined at 251 in third_party/google-perftools-1.8.3/src/malloc_hook-inl.h.'>InvokeMunmapHook</a>(<a href='../Y/1411.html' title='Multiple used in 58 places.'>address</a>, <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>);
<a id='L947' name='L947' />  <strong class='reserved'>return</strong> ((<a href='../S/347.html#L62' title='Defined at 62 in src/lmntal.h.'>BOOL</a> (<a href='../Y/926.html' title='Multiple used in 29 places.'>WINAPI</a> *)(<a href='../Y/331.html' title='Multiple used in 28 places.'>HANDLE</a>, <a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a>, <a href='../Y/733.html' title='Multiple used in 9 places.'>SIZE_T</a>, <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a>))
<a id='L948' name='L948' />          <a href='../Y/2493.html' title='Multiple used in 20 places.'>function_info_</a>[<a href='../S/684.html#L334' title='Defined at 334 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kVirtualFreeEx</a>].<a href='../Y/4040.html' title='Multiple used in 13 places.'>origstub_fn</a>)(
<a id='L949' name='L949' />              <a href='../Y/4278.html' title='Multiple used in 32 places.'>process</a>, <a href='../Y/1411.html' title='Multiple used in 58 places.'>address</a>, <a href='../S/555.html#L187' title='Defined at 187 in third_party/google-perftools-1.8.3/src/debugallocation.cc.'>size</a>, <a href='../Y/5486.html' title='Multiple used in 318 places.'>type</a>);
<a id='L950' name='L950' /><em class='brace'>}</em>
<a id='L951' name='L951' />
<a id='L952' name='L952' /><a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a> <a href='../Y/926.html' title='Multiple used in 29 places.'>WINAPI</a> <a href='../S/684.html#L325' title='Defined at 325 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>WindowsInfo</a>::<a href='../R/1943.html' title='Multiple refered from 2 places.'>Perftools_MapViewOfFileEx</a>(
<a id='L953' name='L953' />    <a href='../Y/331.html' title='Multiple used in 28 places.'>HANDLE</a> <a href='../Y/2607.html' title='Multiple used in 3 places.'>hFileMappingObject</a>, <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a> <a href='../Y/2122.html' title='Multiple used in 3 places.'>dwDesiredAccess</a>, <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a> <a href='../Y/2123.html' title='Multiple used in 3 places.'>dwFileOffsetHigh</a>,
<a id='L954' name='L954' />    <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a> <a href='../Y/2124.html' title='Multiple used in 3 places.'>dwFileOffsetLow</a>, <a href='../Y/733.html' title='Multiple used in 9 places.'>SIZE_T</a> <a href='../Y/2126.html' title='Multiple used in 4 places.'>dwNumberOfBytesToMap</a>, <a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a> <a href='../Y/3342.html' title='Multiple used in 7 places.'>lpBaseAddress</a>) <em class='brace'>{</em>
<a id='L955' name='L955' />  <em class='comment'>// For this function pair, you always deallocate the full block of</em>
<a id='L956' name='L956' />  <em class='comment'>// data that you allocate, so NewHook/DeleteHook is the right API.</em>
<a id='L957' name='L957' />  <a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a> <a href='../Y/4529.html' title='Multiple used in 474 places.'>result</a> = ((<a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a> (<a href='../Y/926.html' title='Multiple used in 29 places.'>WINAPI</a> *)(<a href='../Y/331.html' title='Multiple used in 28 places.'>HANDLE</a>, <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a>, <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a>, <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a>,
<a id='L958' name='L958' />                                      <a href='../Y/733.html' title='Multiple used in 9 places.'>SIZE_T</a>, <a href='../Y/433.html' title='Multiple used in 24 places.'>LPVOID</a>))
<a id='L959' name='L959' />                   <a href='../Y/2493.html' title='Multiple used in 20 places.'>function_info_</a>[<a href='../S/684.html#L335' title='Defined at 335 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kMapViewOfFileEx</a>].<a href='../Y/4040.html' title='Multiple used in 13 places.'>origstub_fn</a>)(
<a id='L960' name='L960' />                       <a href='../Y/2607.html' title='Multiple used in 3 places.'>hFileMappingObject</a>, <a href='../Y/2122.html' title='Multiple used in 3 places.'>dwDesiredAccess</a>, <a href='../Y/2123.html' title='Multiple used in 3 places.'>dwFileOffsetHigh</a>,
<a id='L961' name='L961' />                       <a href='../Y/2124.html' title='Multiple used in 3 places.'>dwFileOffsetLow</a>, <a href='../Y/2126.html' title='Multiple used in 4 places.'>dwNumberOfBytesToMap</a>, <a href='../Y/3342.html' title='Multiple used in 7 places.'>lpBaseAddress</a>);
<a id='L962' name='L962' />  <a href='../Y/501.html' title='Multiple used in 224 places.'>MallocHook</a>::<a href='../S/581.html#L159' title='Defined at 159 in third_party/google-perftools-1.8.3/src/malloc_hook-inl.h.'>InvokeNewHook</a>(<a href='../Y/4529.html' title='Multiple used in 474 places.'>result</a>, <a href='../Y/2126.html' title='Multiple used in 4 places.'>dwNumberOfBytesToMap</a>);
<a id='L963' name='L963' />  <strong class='reserved'>return</strong> <a href='../Y/4529.html' title='Multiple used in 474 places.'>result</a>;
<a id='L964' name='L964' /><em class='brace'>}</em>
<a id='L965' name='L965' />
<a id='L966' name='L966' /><a href='../S/347.html#L62' title='Defined at 62 in src/lmntal.h.'>BOOL</a> <a href='../Y/926.html' title='Multiple used in 29 places.'>WINAPI</a> <a href='../S/684.html#L325' title='Defined at 325 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>WindowsInfo</a>::<a href='../R/1944.html' title='Multiple refered from 2 places.'>Perftools_UnmapViewOfFile</a>(<a href='../Y/431.html' title='Multiple used in 3 places.'>LPCVOID</a> <a href='../Y/3342.html' title='Multiple used in 7 places.'>lpBaseAddress</a>) <em class='brace'>{</em>
<a id='L967' name='L967' />  <a href='../Y/501.html' title='Multiple used in 224 places.'>MallocHook</a>::<a href='../S/581.html#L174' title='Defined at 174 in third_party/google-perftools-1.8.3/src/malloc_hook-inl.h.'>InvokeDeleteHook</a>(<a href='../Y/3342.html' title='Multiple used in 7 places.'>lpBaseAddress</a>);
<a id='L968' name='L968' />  <strong class='reserved'>return</strong> ((<a href='../S/347.html#L62' title='Defined at 62 in src/lmntal.h.'>BOOL</a> (<a href='../Y/926.html' title='Multiple used in 29 places.'>WINAPI</a> *)(<a href='../Y/431.html' title='Multiple used in 3 places.'>LPCVOID</a>))
<a id='L969' name='L969' />          <a href='../Y/2493.html' title='Multiple used in 20 places.'>function_info_</a>[<a href='../S/684.html#L335' title='Defined at 335 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kUnmapViewOfFile</a>].<a href='../Y/4040.html' title='Multiple used in 13 places.'>origstub_fn</a>)(
<a id='L970' name='L970' />              <a href='../Y/3342.html' title='Multiple used in 7 places.'>lpBaseAddress</a>);
<a id='L971' name='L971' /><em class='brace'>}</em>
<a id='L972' name='L972' />
<a id='L973' name='L973' /><em class='comment'>// g_load_map holds a copy of windows' refcount for how many times</em>
<a id='L974' name='L974' /><em class='comment'>// each currently loaded module has been loaded and unloaded.  We use</em>
<a id='L975' name='L975' /><em class='comment'>// it as an optimization when the same module is loaded more than</em>
<a id='L976' name='L976' /><em class='comment'>// once: as long as the refcount stays above 1, we don't need to worry</em>
<a id='L977' name='L977' /><em class='comment'>// about patching because it's already patched.  Likewise, we don't</em>
<a id='L978' name='L978' /><em class='comment'>// need to unpatch until the refcount drops to 0.  load_map is</em>
<a id='L979' name='L979' /><em class='comment'>// maintained in LoadLibraryExW and FreeLibrary, and only covers</em>
<a id='L980' name='L980' /><em class='comment'>// modules explicitly loaded/freed via those interfaces.</em>
<a id='L981' name='L981' /><strong class='reserved'>static</strong> <a href='../Y/5100.html' title='Multiple used in 181 places.'>std</a>::<a href='../Y/3412.html' title='Multiple used in 91 places.'>map</a>&lt;<a href='../Y/351.html' title='Multiple used in 18 places.'>HMODULE</a>, <strong class='reserved'>int</strong>&gt;* g_load_map = <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>;
<a id='L982' name='L982' />
<a id='L983' name='L983' /><a href='../Y/351.html' title='Multiple used in 18 places.'>HMODULE</a> <a href='../Y/926.html' title='Multiple used in 29 places.'>WINAPI</a> <a href='../S/684.html#L325' title='Defined at 325 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>WindowsInfo</a>::<a href='../R/1942.html' title='Multiple refered from 2 places.'>Perftools_LoadLibraryExW</a>(<a href='../Y/432.html' title='Multiple used in 4 places.'>LPCWSTR</a> <a href='../Y/3344.html' title='Multiple used in 4 places.'>lpFileName</a>,
<a id='L984' name='L984' />                                                     <a href='../Y/331.html' title='Multiple used in 28 places.'>HANDLE</a> <a href='../Y/2606.html' title='Multiple used in 3 places.'>hFile</a>,
<a id='L985' name='L985' />                                                     <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a> <a href='../Y/2125.html' title='Multiple used in 9 places.'>dwFlags</a>) <em class='brace'>{</em>
<a id='L986' name='L986' />  <a href='../Y/351.html' title='Multiple used in 18 places.'>HMODULE</a> <a href='../Y/4652.html' title='Multiple used in 19 places.'>rv</a>;
<a id='L987' name='L987' />  <em class='comment'>// Check to see if the modules is already loaded, flag 0 gets a</em>
<a id='L988' name='L988' />  <em class='comment'>// reference if it was loaded.  If it was loaded no need to call</em>
<a id='L989' name='L989' />  <em class='comment'>// PatchAllModules, just increase the reference count to match</em>
<a id='L990' name='L990' />  <em class='comment'>// what GetModuleHandleExW does internally inside windows.</em>
<a id='L991' name='L991' />  <strong class='reserved'>if</strong> (::<a href='../Y/309.html' title='Multiple used in 2 places.'>GetModuleHandleExW</a>(0, <a href='../Y/3344.html' title='Multiple used in 4 places.'>lpFileName</a>, &amp;<a href='../Y/4652.html' title='Multiple used in 19 places.'>rv</a>)) <em class='brace'>{</em>
<a id='L992' name='L992' />    <strong class='reserved'>return</strong> <a href='../Y/4652.html' title='Multiple used in 19 places.'>rv</a>;
<a id='L993' name='L993' />  <em class='brace'>}</em> <strong class='reserved'>else</strong> <em class='brace'>{</em>
<a id='L994' name='L994' />    <em class='comment'>// Not already loaded, so load it.</em>
<a id='L995' name='L995' />    <a href='../Y/4652.html' title='Multiple used in 19 places.'>rv</a> = ((<a href='../Y/351.html' title='Multiple used in 18 places.'>HMODULE</a> (<a href='../Y/926.html' title='Multiple used in 29 places.'>WINAPI</a> *)(<a href='../Y/432.html' title='Multiple used in 4 places.'>LPCWSTR</a>, <a href='../Y/331.html' title='Multiple used in 28 places.'>HANDLE</a>, <a href='../Y/115.html' title='Multiple used in 49 places.'>DWORD</a>))
<a id='L996' name='L996' />                  <a href='../Y/2493.html' title='Multiple used in 20 places.'>function_info_</a>[<a href='../S/684.html#L335' title='Defined at 335 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kLoadLibraryExW</a>].<a href='../Y/4040.html' title='Multiple used in 13 places.'>origstub_fn</a>)(
<a id='L997' name='L997' />                      <a href='../Y/3344.html' title='Multiple used in 4 places.'>lpFileName</a>, <a href='../Y/2606.html' title='Multiple used in 3 places.'>hFile</a>, <a href='../Y/2125.html' title='Multiple used in 9 places.'>dwFlags</a>);
<a id='L998' name='L998' />    <em class='comment'>// This will patch any newly loaded libraries, if patching needs</em>
<a id='L999' name='L999' />    <em class='comment'>// to be done.</em>
<a id='L1000' name='L1000' />    <a href='../Y/637.html' title='Multiple used in 4 places.'>PatchAllModules</a>();
<a id='L1001' name='L1001' />
<a id='L1002' name='L1002' />    <strong class='reserved'>return</strong> <a href='../Y/4652.html' title='Multiple used in 19 places.'>rv</a>;
<a id='L1003' name='L1003' />  <em class='brace'>}</em>
<a id='L1004' name='L1004' /><em class='brace'>}</em>
<a id='L1005' name='L1005' />
<a id='L1006' name='L1006' /><a href='../S/347.html#L62' title='Defined at 62 in src/lmntal.h.'>BOOL</a> <a href='../Y/926.html' title='Multiple used in 29 places.'>WINAPI</a> <a href='../S/684.html#L325' title='Defined at 325 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>WindowsInfo</a>::<a href='../R/1939.html' title='Multiple refered from 2 places.'>Perftools_FreeLibrary</a>(<a href='../Y/351.html' title='Multiple used in 18 places.'>HMODULE</a> <a href='../Y/2610.html' title='Multiple used in 5 places.'>hLibModule</a>) <em class='brace'>{</em>
<a id='L1007' name='L1007' />  <a href='../S/347.html#L62' title='Defined at 62 in src/lmntal.h.'>BOOL</a> <a href='../Y/4652.html' title='Multiple used in 19 places.'>rv</a> = ((<a href='../S/347.html#L62' title='Defined at 62 in src/lmntal.h.'>BOOL</a> (<a href='../Y/926.html' title='Multiple used in 29 places.'>WINAPI</a> *)(<a href='../Y/351.html' title='Multiple used in 18 places.'>HMODULE</a>))
<a id='L1008' name='L1008' />             <a href='../Y/2493.html' title='Multiple used in 20 places.'>function_info_</a>[<a href='../S/684.html#L335' title='Defined at 335 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>kFreeLibrary</a>].<a href='../Y/4040.html' title='Multiple used in 13 places.'>origstub_fn</a>)(<a href='../Y/2610.html' title='Multiple used in 5 places.'>hLibModule</a>);
<a id='L1009' name='L1009' />
<a id='L1010' name='L1010' />  <em class='comment'>// Check to see if the module is still loaded by passing the base</em>
<a id='L1011' name='L1011' />  <em class='comment'>// address and seeing if it comes back with the same address.  If it</em>
<a id='L1012' name='L1012' />  <em class='comment'>// is the same address it's still loaded, so the FreeLibrary() call</em>
<a id='L1013' name='L1013' />  <em class='comment'>// was a noop, and there's no need to redo the patching.</em>
<a id='L1014' name='L1014' />  <a href='../Y/351.html' title='Multiple used in 18 places.'>HMODULE</a> <a href='../Y/4068.html' title='Multiple used in 54 places.'>owner</a> = <a href='../Y/551.html' title='Multiple used in 1022 places.'>NULL</a>;
<a id='L1015' name='L1015' />  <a href='../S/347.html#L62' title='Defined at 62 in src/lmntal.h.'>BOOL</a> <a href='../Y/4529.html' title='Multiple used in 474 places.'>result</a> = ::<a href='../Y/309.html' title='Multiple used in 2 places.'>GetModuleHandleExW</a>(
<a id='L1016' name='L1016' />      (GET_MODULE_HANDLE_EX_FLAG_FROM_ADDRESS |
<a id='L1017' name='L1017' />       GET_MODULE_HANDLE_EX_FLAG_UNCHANGED_REFCOUNT),
<a id='L1018' name='L1018' />      (<a href='../Y/432.html' title='Multiple used in 4 places.'>LPCWSTR</a>)<a href='../Y/2610.html' title='Multiple used in 5 places.'>hLibModule</a>,
<a id='L1019' name='L1019' />      &amp;<a href='../Y/4068.html' title='Multiple used in 54 places.'>owner</a>);
<a id='L1020' name='L1020' />  <strong class='reserved'>if</strong> (<a href='../Y/4529.html' title='Multiple used in 474 places.'>result</a> &amp;&amp; <a href='../Y/4068.html' title='Multiple used in 54 places.'>owner</a> == <a href='../Y/2610.html' title='Multiple used in 5 places.'>hLibModule</a>)
<a id='L1021' name='L1021' />    <strong class='reserved'>return</strong> <a href='../Y/4652.html' title='Multiple used in 19 places.'>rv</a>;
<a id='L1022' name='L1022' />
<a id='L1023' name='L1023' />  <a href='../Y/637.html' title='Multiple used in 4 places.'>PatchAllModules</a>();    <em class='comment'>// this will fix up the list of patched libraries</em>
<a id='L1024' name='L1024' />  <strong class='reserved'>return</strong> <a href='../Y/4652.html' title='Multiple used in 19 places.'>rv</a>;
<a id='L1025' name='L1025' /><em class='brace'>}</em>
<a id='L1026' name='L1026' />
<a id='L1027' name='L1027' />
<a id='L1028' name='L1028' /><em class='comment'>// ---------------------------------------------------------------------</em>
<a id='L1029' name='L1029' /><em class='comment'>// PatchWindowsFunctions()</em>
<a id='L1030' name='L1030' /><em class='comment'>//    This is the function that is exposed to the outside world.</em>
<a id='L1031' name='L1031' /><em class='comment'>//    It should be called before the program becomes multi-threaded,</em>
<a id='L1032' name='L1032' /><em class='comment'>//    since main_executable_windows.Patch() is not thread-safe.</em>
<a id='L1033' name='L1033' /><em class='comment'>// ---------------------------------------------------------------------</em>
<a id='L1034' name='L1034' />
<a id='L1035' name='L1035' /><strong class='reserved'>void</strong> <a href='../R/1936.html' title='Multiple refered from 3 places.'>PatchWindowsFunctions</a>() <em class='brace'>{</em>
<a id='L1036' name='L1036' />  <em class='comment'>// This does the libc patching in every module, and the main executable.</em>
<a id='L1037' name='L1037' />  <a href='../Y/637.html' title='Multiple used in 4 places.'>PatchAllModules</a>();
<a id='L1038' name='L1038' />  <a href='../Y/3383.html' title='Multiple used in 3 places.'>main_executable_windows</a>.<a href='../Y/636.html' title='Multiple used in 18 places.'>Patch</a>();
<a id='L1039' name='L1039' /><em class='brace'>}</em>
<a id='L1040' name='L1040' />
<a id='L1041' name='L1041' /><em class='sharp'>#if</em> 0
<a id='L1042' name='L1042' /><em class='comment'>// It's possible to unpatch all the functions when we are exiting.</em>
<a id='L1043' name='L1043' />
<a id='L1044' name='L1044' /><em class='comment'>// The idea is to handle properly windows-internal data that is</em>
<a id='L1045' name='L1045' /><em class='comment'>// allocated before PatchWindowsFunctions is called.  If all</em>
<a id='L1046' name='L1046' /><em class='comment'>// destruction happened in reverse order from construction, then we</em>
<a id='L1047' name='L1047' /><em class='comment'>// could call UnpatchWindowsFunctions at just the right time, so that</em>
<a id='L1048' name='L1048' /><em class='comment'>// that early-allocated data would be freed using the windows</em>
<a id='L1049' name='L1049' /><em class='comment'>// allocation functions rather than tcmalloc.  The problem is that</em>
<a id='L1050' name='L1050' /><em class='comment'>// windows allocates some structures lazily, so it would allocate them</em>
<a id='L1051' name='L1051' /><em class='comment'>// late (using tcmalloc) and then try to deallocate them late as well.</em>
<a id='L1052' name='L1052' /><em class='comment'>// So instead of unpatching, we just modify all the tcmalloc routines</em>
<a id='L1053' name='L1053' /><em class='comment'>// so they call through to the libc rountines if the memory in</em>
<a id='L1054' name='L1054' /><em class='comment'>// question doesn't seem to have been allocated with tcmalloc.  I keep</em>
<a id='L1055' name='L1055' /><em class='comment'>// this unpatch code around for reference.</em>
<a id='L1056' name='L1056' />
<a id='L1057' name='L1057' /><strong class='reserved'>void</strong> UnpatchWindowsFunctions() <em class='brace'>{</em>
<a id='L1058' name='L1058' />  <em class='comment'>// We need to go back to the system malloc/etc at global destruct time,</em>
<a id='L1059' name='L1059' />  <em class='comment'>// so objects that were constructed before tcmalloc, using the system</em>
<a id='L1060' name='L1060' />  <em class='comment'>// malloc, can destroy themselves using the system free.  This depends</em>
<a id='L1061' name='L1061' />  <em class='comment'>// on DLLs unloading in the reverse order in which they load!</em>
<a id='L1062' name='L1062' />  <em class='comment'>//</em>
<a id='L1063' name='L1063' />  <em class='comment'>// We also go back to the default HeapAlloc/etc, just for consistency.</em>
<a id='L1064' name='L1064' />  <em class='comment'>// Who knows, it may help avoid weird bugs in some situations.</em>
<a id='L1065' name='L1065' />  <a href='../Y/3383.html' title='Multiple used in 3 places.'>main_executable_windows</a>.<a href='../S/687.html#L253' title='Defined at 253 in third_party/google-perftools-1.8.3/src/windows/preamble_patcher.cc.'>Unpatch</a>();
<a id='L1066' name='L1066' />  <a href='../Y/3382.html' title='Multiple used in 6 places.'>main_executable</a>.<a href='../S/687.html#L253' title='Defined at 253 in third_party/google-perftools-1.8.3/src/windows/preamble_patcher.cc.'>Unpatch</a>();
<a id='L1067' name='L1067' />  <strong class='reserved'>if</strong> (<a href='../Y/3225.html' title='Multiple used in 4 places.'>libc1</a>.<a href='../S/684.html#L221' title='Defined at 221 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>is_valid</a>()) <a href='../Y/3225.html' title='Multiple used in 4 places.'>libc1</a>.<a href='../S/687.html#L253' title='Defined at 253 in third_party/google-perftools-1.8.3/src/windows/preamble_patcher.cc.'>Unpatch</a>();
<a id='L1068' name='L1068' />  <strong class='reserved'>if</strong> (<a href='../Y/3226.html' title='Multiple used in 4 places.'>libc2</a>.<a href='../S/684.html#L221' title='Defined at 221 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>is_valid</a>()) <a href='../Y/3226.html' title='Multiple used in 4 places.'>libc2</a>.<a href='../S/687.html#L253' title='Defined at 253 in third_party/google-perftools-1.8.3/src/windows/preamble_patcher.cc.'>Unpatch</a>();
<a id='L1069' name='L1069' />  <strong class='reserved'>if</strong> (<a href='../Y/3227.html' title='Multiple used in 4 places.'>libc3</a>.<a href='../S/684.html#L221' title='Defined at 221 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>is_valid</a>()) <a href='../Y/3227.html' title='Multiple used in 4 places.'>libc3</a>.<a href='../S/687.html#L253' title='Defined at 253 in third_party/google-perftools-1.8.3/src/windows/preamble_patcher.cc.'>Unpatch</a>();
<a id='L1070' name='L1070' />  <strong class='reserved'>if</strong> (<a href='../Y/3228.html' title='Multiple used in 4 places.'>libc4</a>.<a href='../S/684.html#L221' title='Defined at 221 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>is_valid</a>()) <a href='../Y/3228.html' title='Multiple used in 4 places.'>libc4</a>.<a href='../S/687.html#L253' title='Defined at 253 in third_party/google-perftools-1.8.3/src/windows/preamble_patcher.cc.'>Unpatch</a>();
<a id='L1071' name='L1071' />  <strong class='reserved'>if</strong> (<a href='../Y/3229.html' title='Multiple used in 4 places.'>libc5</a>.<a href='../S/684.html#L221' title='Defined at 221 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>is_valid</a>()) <a href='../Y/3229.html' title='Multiple used in 4 places.'>libc5</a>.<a href='../S/687.html#L253' title='Defined at 253 in third_party/google-perftools-1.8.3/src/windows/preamble_patcher.cc.'>Unpatch</a>();
<a id='L1072' name='L1072' />  <strong class='reserved'>if</strong> (<a href='../Y/3230.html' title='Multiple used in 4 places.'>libc6</a>.<a href='../S/684.html#L221' title='Defined at 221 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>is_valid</a>()) <a href='../Y/3230.html' title='Multiple used in 4 places.'>libc6</a>.<a href='../S/687.html#L253' title='Defined at 253 in third_party/google-perftools-1.8.3/src/windows/preamble_patcher.cc.'>Unpatch</a>();
<a id='L1073' name='L1073' />  <strong class='reserved'>if</strong> (<a href='../Y/3231.html' title='Multiple used in 4 places.'>libc7</a>.<a href='../S/684.html#L221' title='Defined at 221 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>is_valid</a>()) <a href='../Y/3231.html' title='Multiple used in 4 places.'>libc7</a>.<a href='../S/687.html#L253' title='Defined at 253 in third_party/google-perftools-1.8.3/src/windows/preamble_patcher.cc.'>Unpatch</a>();
<a id='L1074' name='L1074' />  <strong class='reserved'>if</strong> (<a href='../Y/3232.html' title='Multiple used in 4 places.'>libc8</a>.<a href='../S/684.html#L221' title='Defined at 221 in third_party/google-perftools-1.8.3/src/windows/patch_functions.cc.'>is_valid</a>()) <a href='../Y/3232.html' title='Multiple used in 4 places.'>libc8</a>.<a href='../S/687.html#L253' title='Defined at 253 in third_party/google-perftools-1.8.3/src/windows/preamble_patcher.cc.'>Unpatch</a>();
<a id='L1075' name='L1075' /><em class='brace'>}</em>
<a id='L1076' name='L1076' /><em class='sharp'>#endif</em>
</pre>
<hr />
<a id='BOTTOM' name='BOTTOM' />
<em class='comment'>/* [&lt;][&gt;]<a href='#L123'>[^]</a><a href='#L1057'>[v]</a><a href='#TOP'>[top]</a>[bottom]<a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</em>
</body>
</html>
